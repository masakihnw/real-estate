---
description: SwiftData Listing モデルのストアドプロパティ変更時にスキーマバージョンのインクリメントを強制する
globs:
  - real-estate-ios/RealEstateApp/Models/Listing.swift
  - real-estate-ios/RealEstateApp/RealEstateAppApp.swift
  - real-estate-ios/RealEstateApp/Services/ListingStore.swift
alwaysApply: false
---

# SwiftData スキーマバージョン管理ルール

## 背景

`Listing` は SwiftData の `@Model` クラスで、50以上のストアドプロパティを持つ。
SwiftData の自動軽量マイグレーションはこの規模のモデルでは信頼できず、
スキーマ変更時に Objective-C レベルの NSException でアプリが起動クラッシュする。

そのため `RealEstateAppApp.swift` に簡易バージョン管理を実装済み:
- `currentSchemaVersion` を比較し、旧バージョンの DB を自動削除してクリーンスタートする方式

## 必須ルール

### Listing.swift にストアドプロパティを追加・削除・型変更する場合

以下の **3つ全て** を同じコミットで必ず行うこと:

1. **`RealEstateAppApp.swift` の `currentSchemaVersion` をインクリメント**
   - コメントに何を変更したか記載する
   - 例: `private static let currentSchemaVersion = 4  // v4: newField 追加`

2. **`ListingStore.swift` の `update(existing:from:)` メソッドに新プロパティのコピーを追加**
   - 既存物件の更新時に新フィールドが反映されないバグを防ぐ
   - 例: `existing.newField = new.newField`

3. **ビルド番号をインクリメント**（以下3ファイル全て）
   - `Info.plist` の `CFBundleVersion`
   - `project.pbxproj` の `CURRENT_PROJECT_VERSION`（Debug / Release 両方）
   - `project.yml` の `CURRENT_PROJECT_VERSION`

### チェックリスト

Listing.swift を編集した際は、以下を自問すること:

- [ ] `var` / `let` でストアドプロパティを追加・削除・型変更したか？
  - YES → 上記 3 ステップを実行
  - NO（computed property やメソッドのみの変更）→ スキーマバージョン変更不要

### やってはいけないこと

- スキーマバージョンをインクリメントせずに Listing のストアドプロパティを変更する
  → **アプリが起動時にクラッシュする**（過去に2回発生）
