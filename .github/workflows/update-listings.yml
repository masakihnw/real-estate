name: Update Listings

# このワークフローは物件情報を自動取得し、GitHubにコミット・プッシュします
# セットアップ: リポジトリにこのファイルを配置するだけで動作します

on:
  schedule:
    # 1日4回実行: JST 06:00 / 12:00 / 19:00 / 00:00
    # 朝・昼・夕方・深夜に最新物件を反映
    # タイムゾーン: https://crontab.guru/ で確認可能
    - cron: '0 21 * * *'  # JST 06:00（朝）
    - cron: '0 3 * * *'   # JST 12:00（昼）
    - cron: '0 10 * * *'  # JST 19:00（夕方）
    - cron: '0 15 * * *'  # JST 00:00（深夜）
  workflow_dispatch:  # 手動実行も可能（GitHub Actions タブから実行）

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # コミット・プッシュに必要（リポジトリ設定でも「Read and write」を有効にすること）

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # 履歴を全て取得（差分検出のため）

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        working-directory: scraping-tool
        run: |
          pip install -r requirements.txt

      - name: Install push dependencies
        run: pip install PyJWT cryptography
        continue-on-error: true

      - name: Run update script
        id: scrape
        working-directory: scraping-tool
        env:
          SUMAI_USER: ${{ secrets.SUMAI_USER }}
          SUMAI_PASS: ${{ secrets.SUMAI_PASS }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          chmod +x scripts/update_listings.sh
          ./scripts/update_listings.sh --no-git  # レポート・latest/previous まで。Notion は次ステップで実行

      # スクリプトで「変更なし」と判断されると早期終了し、latest.json/report を更新しない。
      # その場合 git に変更が残らないため changed=false となり、Slack・コミットはスキップされる。
      - name: Check for changes
        id: check
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: steps.check.outputs.changed == 'true'
        working-directory: scraping-tool
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python3 slack_notify.py results/latest.json results/previous.json results/report/report.md

      # Notion 同期が失敗してもジョブは成功扱いとし、続けてコミット・プッシュする（md は必ずリポジトリに残る）
      - name: Sync to Notion
        if: steps.check.outputs.changed == 'true'
        continue-on-error: true
        working-directory: scraping-tool
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          if [ -n "$NOTION_TOKEN" ] && [ -n "$NOTION_DATABASE_ID" ]; then
            python3 notion-tool/sync_to_notion.py results/latest.json --compare results/previous.json
          else
            echo "NOTION_TOKEN または NOTION_DATABASE_ID が未設定のため Notion 同期をスキップします"
          fi

      - name: Commit and push
        if: steps.check.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          DATE=$(date +%Y%m%d_%H%M%S)
          COUNT=$(python3 -c "import json, pathlib; f=pathlib.Path('scraping-tool/results/latest.json'); print(len(json.load(open(f))) if f.exists() else 0)")

          git add scraping-tool/results/
          [ -f scraping-tool/data/building_units.json ] && git add scraping-tool/data/building_units.json
          [ -f scraping-tool/data/geocode_cache.json ] && git add scraping-tool/data/geocode_cache.json
          [ -f scraping-tool/data/sumai_surfin_cache.json ] && git add scraping-tool/data/sumai_surfin_cache.json
          git commit -m "Update listings: ${DATE}

          取得件数: ${COUNT}件
          レポート: scraping-tool/results/report/report.md
          自動更新: GitHub Actions" || exit 0

          git pull --rebase origin ${{ github.ref_name }}
          git push origin HEAD:refs/heads/${{ github.ref_name }}

      # スクレイピング失敗時に Slack で通知（SLACK_WEBHOOK_URL が設定されている場合のみ）
      - name: Notify failure to Slack
        if: failure() && steps.scrape.outcome == 'failure'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -s -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-type: application/json' \
              -d "{\"text\": \":rotating_light: *物件スクレイピング失敗*\nワークフロー: ${{ github.workflow }}\n実行: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"
          fi
