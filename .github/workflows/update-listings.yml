name: Update Listings

# このワークフローは物件情報を自動取得し、GitHubにコミット・プッシュします
# セットアップ: リポジトリにこのファイルを配置するだけで動作します

on:
  schedule:
    # 毎日 04:00 JST に実行（UTC 19:00 = 日本時間 翌日 04:00）
    # タイムゾーン: https://crontab.guru/ で確認可能
    - cron: '0 19 * * *'
  workflow_dispatch:  # 手動実行も可能（GitHub Actions タブから実行）

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # コミット・プッシュに必要（リポジトリ設定でも「Read and write」を有効にすること）

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # 履歴を全て取得（差分検出のため）

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        working-directory: scraping-tool
        run: |
          pip install -r requirements.txt

      - name: Run update script
        working-directory: scraping-tool
        run: |
          chmod +x scripts/update_listings.sh
          ./scripts/update_listings.sh --no-git  # レポート・latest/previous まで。Notion は次ステップで実行

      # スクリプトで「変更なし」と判断されると早期終了し、latest.json/report を更新しない。
      # その場合 git に変更が残らないため changed=false となり、Slack・コミットはスキップされる。
      - name: Check for changes
        id: check
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: steps.check.outputs.changed == 'true'
        working-directory: scraping-tool
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python3 slack_notify.py results/latest.json results/previous.json results/report/report.md

      # Notion 同期が失敗してもジョブは成功扱いとし、続けてコミット・プッシュする（md は必ずリポジトリに残る）
      - name: Sync to Notion
        if: steps.check.outputs.changed == 'true'
        continue-on-error: true
        working-directory: scraping-tool
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          if [ -n "$NOTION_TOKEN" ] && [ -n "$NOTION_DATABASE_ID" ]; then
            python3 notion-tool/sync_to_notion.py results/latest.json --compare results/previous.json
          else
            echo "NOTION_TOKEN または NOTION_DATABASE_ID が未設定のため Notion 同期をスキップします"
          fi

      - name: Commit and push
        if: steps.check.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          DATE=$(date +%Y%m%d_%H%M%S)
          COUNT=$(python3 -c "import json, glob; files = glob.glob('scraping-tool/results/current_*.json'); print(len(json.load(open(max(files)))) if files else 0)")

          git add scraping-tool/results/
          [ -f scraping-tool/data/building_units.json ] && git add scraping-tool/data/building_units.json
          git commit -m "Update listings: ${DATE}

          取得件数: ${COUNT}件
          レポート: scraping-tool/results/report/report.md
          自動更新: GitHub Actions" || exit 0

          git pull --rebase origin ${{ github.ref_name }}
          git push origin HEAD:refs/heads/${{ github.ref_name }}
