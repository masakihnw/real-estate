# Slack通知・東京23区フィルタ修正（2026-01-30）

## 起きていたこと

1. **「前回から変更がなさそうなのにSlackが送られる」**  
   変更検知が **URL** 基準だったため、同じ物件が SUUMO と HOME'S で別URLで出ると「7件削除・7件新規」のように毎回差分と判定され、通知が飛んでいた。

2. **「東京23区以外の物件が送られる」**  
   過去の `latest.json` に神奈川など他県の物件（例: デイパーク横濱天王町）が含まれていた。SUUMO は東京都一覧から取得しているが、URL に `/kanagawa/` 等が含まれる物件を除外していなかった。また住所が空の場合はすべて除外していたため、住所パース失敗時に東京23区の物件まで0件になる可能性があった。

3. **「対象件数0件で削除7件の通知が来る」**  
   上記の結果、現行取得が0件（または住所パースで全除外）のときに「削除7件」だけの通知が送られていた。

## 対応内容

### 1. 変更検知を「物件キー」で行う

- **`generate_report.py`**  
  - `listing_key(r)` を追加（名前・間取り・専有・価格・住所・築年・駅徒歩で一意キー）。  
  - `compare_listings()` を URL ではなくこのキーで比較するよう変更。
- **`check_changes.py`**  
  - 同上の `listing_key` で current/previous を比較。同じ物件が別URL（SUUMO/HOME'S）でも「同一」とみなす。
- **`main.py`**  
  - 重複除去で `generate_report.listing_key` を利用（キー定義を1か所に統一）。

これにより「実質同じ物件のURLだけ変わった」場合は差分なしと判定され、不要なSlack通知が出なくなります。

### 2. 東京23区フィルタの強化（SUUMO）

- **`config.py`**  
  - `NON_TOKYO_23_URL_PATHS` を追加（`/kanagawa/`, `/chiba/`, `/saitama/` 等）。
- **`suumo_scraper.py`**  
  - `_is_tokyo_23(address, url)` に変更。  
    - URL に他県パスが含まれる → 除外。  
    - 住所に23区の区名が含まれる → 採用。  
    - **住所が空でも** URL に `/tokyo/` が含まれる → 採用（一覧の住所パース失敗時の救済）。

神奈川等の物件は URL で除外され、住所が取れない東京物件も URL が `/tokyo/` なら残るようにしました。

### 3. ワークフロー（コミットメッセージ）

- コミットメッセージの「取得件数」を、削除済みの `current_*.json` ではなく **`latest.json`** の件数から取得するよう変更。

## 運用上の注意

- **初回または23区フィルタ導入後**  
  既存の `latest.json` に他県物件が含まれていると、次回実行で「削除」としてレポート・Slackに出ます。1回だけ出れば正常です。
- **0件のとき**  
  取得0件のときは「削除のみ」の通知になる場合があります。SUUMO/HOME'S のページ構造変更で住所が取れないと0件になる可能性があるため、その場合は URL 救済で東京物件が残るようにしてあります。
