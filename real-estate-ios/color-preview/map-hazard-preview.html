<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—é‡ã­åˆã‚ã›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1c1c1e; }
  #map { width: 100%; height: 100vh; }

  /* Control panel */
  .panel {
    position: fixed; top: 12px; right: 12px; z-index: 1000;
    background: rgba(255,255,255,0.97); backdrop-filter: blur(12px);
    border-radius: 14px; box-shadow: 0 4px 24px rgba(0,0,0,0.15);
    width: 300px; max-height: calc(100vh - 24px); overflow-y: auto;
    font-size: 13px; color: #1c1c1e;
  }
  .panel::-webkit-scrollbar { display: none; }
  .panel-header {
    padding: 14px 16px 10px; font-size: 17px; font-weight: 700;
    border-bottom: 1px solid rgba(0,0,0,0.06); position: sticky; top: 0;
    background: rgba(255,255,255,0.97); backdrop-filter: blur(12px);
    border-radius: 14px 14px 0 0; display: flex; justify-content: space-between; align-items: center;
  }
  .panel-header .hint { font-size: 10px; color: #8e8e93; font-weight: 400; }
  .section-title {
    font-size: 10px; font-weight: 700; color: #8e8e93;
    padding: 12px 16px 4px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .layer-row {
    display: flex; align-items: center; padding: 6px 16px; cursor: pointer;
    transition: background 0.15s;
  }
  .layer-row:hover { background: rgba(0,0,0,0.03); }
  .layer-row .icon { width: 22px; text-align: center; font-size: 13px; margin-right: 6px; }
  .layer-row .name { flex: 1; font-size: 12px; }
  .layer-row .info-btn {
    width: 18px; height: 18px; border-radius: 50%; border: none; background: none;
    font-size: 12px; color: #8e8e93; cursor: pointer; display: flex;
    align-items: center; justify-content: center; flex-shrink: 0; padding: 0;
    margin-right: 4px;
  }
  .layer-row .info-btn:hover { color: #007AFF; }
  .layer-row .toggle {
    width: 38px; height: 22px; border-radius: 11px; background: #e9e9eb;
    position: relative; transition: background 0.2s; flex-shrink: 0;
  }
  .layer-row .toggle.on { background: #007AFF; }
  .layer-row .toggle::after {
    content: ''; position: absolute; width: 18px; height: 18px;
    border-radius: 9px; background: #fff; top: 2px; left: 2px;
    transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  }
  .layer-row .toggle.on::after { transform: translateX(16px); }
  /* Opacity slider row (shown when layer is ON) */
  .opacity-row {
    display: none; padding: 0 16px 4px 46px; align-items: center; gap: 6px;
  }
  .opacity-row.show { display: flex; }
  .opacity-row input[type=range] {
    flex: 1; height: 3px; -webkit-appearance: none; background: #ddd; border-radius: 2px; outline: none;
  }
  .opacity-row input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%;
    background: #007AFF; cursor: pointer; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .opacity-row .opacity-val { font-size: 10px; color: #8e8e93; width: 28px; text-align: right; }
  .divider { height: 1px; background: rgba(0,0,0,0.06); margin: 0 16px; }

  /* Info popup */
  .info-popup {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    z-index: 2000; background: #fff; border-radius: 16px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.2); width: 320px; max-height: 80vh;
    overflow-y: auto; padding: 20px;
  }
  .info-overlay {
    position: fixed; inset: 0; z-index: 1999; background: rgba(0,0,0,0.3);
  }
  .info-popup h4 { font-size: 15px; margin: 0 0 8px; display: flex; align-items: center; gap: 6px; }
  .info-popup .desc { font-size: 12px; color: #666; line-height: 1.5; margin-bottom: 12px; }
  .info-popup .legend-title { font-size: 12px; font-weight: 600; margin-bottom: 6px; }
  .info-popup .legend-item { display: flex; align-items: center; gap: 8px; margin: 3px 0; font-size: 11px; }
  .info-popup .legend-swatch { width: 24px; height: 14px; border-radius: 3px; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.08); }
  .info-popup .source { font-size: 10px; color: #bbb; margin-top: 10px; }
  .info-popup .close-btn {
    position: absolute; top: 12px; right: 12px; border: none; background: rgba(0,0,0,0.06);
    border-radius: 50%; width: 26px; height: 26px; font-size: 14px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; color: #666;
  }
  .info-popup .close-btn:hover { background: rgba(0,0,0,0.1); }

  /* Floating active legend (bottom-left) - M-1: æŠ˜ã‚ŠãŸãŸã¿å¯¾å¿œ */
  .active-legend {
    position: fixed; bottom: 60px; left: 16px; z-index: 1000;
    background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
    border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.12);
    padding: 8px 12px; max-width: 220px; display: none;
  }
  .active-legend.show { display: block; }
  .active-legend .al-title { font-size: 9px; font-weight: 700; color: #8e8e93; margin-bottom: 4px; text-transform: uppercase; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
  .active-legend .al-title .toggle-btn { font-size: 10px; color: #007AFF; font-weight: 500; }
  .active-legend.collapsed .al-body { display: none; }
  .active-legend.collapsed .al-hint { display: none; }
  .active-legend .al-item {
    display: flex; align-items: center; gap: 5px; margin: 2px 0; font-size: 10px;
    cursor: pointer; padding: 2px 0; border-radius: 4px; transition: background 0.15s;
  }
  .active-legend .al-item:hover { background: rgba(0,0,0,0.04); }
  .active-legend .al-swatch { width: 12px; height: 8px; border-radius: 2px; flex-shrink: 0; }
  .active-legend .al-hint { font-size: 9px; color: #bbb; margin-top: 4px; }

  /* Legend */
  .legend-section { padding: 6px 16px 8px; }
  .legend-row { display: flex; align-items: center; gap: 6px; margin: 2px 0; font-size: 11px; color: #666; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  /* Pin count */
  .pin-count {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    z-index: 1000; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
    padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: 600;
    box-shadow: 0 2px 12px rgba(0,0,0,0.12); color: #1c1c1e;
  }

  /* All layers button */
  .btn-all {
    display: block; margin: 6px 16px 8px; padding: 7px; border: none;
    border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer;
    text-align: center; transition: all 0.2s;
  }
  .btn-on { background: #007AFF; color: #fff; }
  .btn-off { background: rgba(0,122,255,0.08); color: #007AFF; }

  /* Hazard identify popup on map */
  .hazard-id-popup { font-family: -apple-system, sans-serif; }
  .hazard-id-popup .hid-title { font-size: 11px; font-weight: 700; margin-bottom: 6px; color: #333; }
  .hazard-id-popup .hid-chip {
    display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px;
    border-radius: 5px; font-size: 10px; font-weight: 600; margin: 2px 2px;
  }
  .hazard-id-popup .hid-none { font-size: 11px; color: #999; }

  @media (max-width: 768px) { .panel { width: 260px; top: 8px; right: 8px; } }
  @media (max-width: 480px) {
    .panel { position: fixed; top: auto; bottom: 0; left: 0; right: 0; width: 100%; border-radius: 16px 16px 0 0; max-height: 50vh; }
    .active-legend { bottom: 55vh; }
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <div class="panel-header">
    <span>ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—</span>
    <span class="hint">åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºèª</span>
  </div>

  <div class="section-title">åŸºæœ¬ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
  <div class="layer-row" onclick="toggleLayer('flood')">
    <span class="icon">ğŸŒŠ</span><span class="name">æ´ªæ°´æµ¸æ°´æƒ³å®š</span>
    <button class="info-btn" onclick="event.stopPropagation();showInfo('flood')">â“˜</button>
    <span class="toggle" id="t-flood"></span>
  </div>
  <div class="opacity-row" id="o-flood"><input type="range" min="10" max="100" value="60" oninput="setOpacity('flood',this.value)"><span class="opacity-val">60%</span></div>

  <div class="layer-row" onclick="toggleLayer('inlandWater')">
    <span class="icon">ğŸ’§</span><span class="name">å†…æ°´æµ¸æ°´</span>
    <button class="info-btn" onclick="event.stopPropagation();showInfo('inlandWater')">â“˜</button>
    <span class="toggle" id="t-inlandWater"></span>
  </div>
  <div class="opacity-row" id="o-inlandWater"><input type="range" min="10" max="100" value="60" oninput="setOpacity('inlandWater',this.value)"><span class="opacity-val">60%</span></div>

  <div class="layer-row" onclick="toggleLayer('sediment')">
    <span class="icon">â›°</span><span class="name">åœŸç ‚ç½å®³è­¦æˆ’</span>
    <button class="info-btn" onclick="event.stopPropagation();showInfo('sediment')">â“˜</button>
    <span class="toggle" id="t-sediment"></span>
  </div>
  <div class="opacity-row" id="o-sediment"><input type="range" min="10" max="100" value="60" oninput="setOpacity('sediment',this.value)"><span class="opacity-val">60%</span></div>

  <div class="layer-row" onclick="toggleLayer('stormSurge')">
    <span class="icon">ğŸŒŠ</span><span class="name">é«˜æ½®æµ¸æ°´æƒ³å®š</span>
    <button class="info-btn" onclick="event.stopPropagation();showInfo('stormSurge')">â“˜</button>
    <span class="toggle" id="t-stormSurge"></span>
  </div>
  <div class="opacity-row" id="o-stormSurge"><input type="range" min="10" max="100" value="60" oninput="setOpacity('stormSurge',this.value)"><span class="opacity-val">60%</span></div>

  <div class="layer-row" onclick="toggleLayer('tsunami')">
    <span class="icon">ğŸŒŠ</span><span class="name">æ´¥æ³¢æµ¸æ°´æƒ³å®š</span>
    <button class="info-btn" onclick="event.stopPropagation();showInfo('tsunami')">â“˜</button>
    <span class="toggle" id="t-tsunami"></span>
  </div>
  <div class="opacity-row" id="o-tsunami"><input type="range" min="10" max="100" value="60" oninput="setOpacity('tsunami',this.value)"><span class="opacity-val">60%</span></div>

  <div class="layer-row" onclick="toggleLayer('liquefaction')">
    <span class="icon">ã€°</span><span class="name">æ¶²çŠ¶åŒ–</span>
    <button class="info-btn" onclick="event.stopPropagation();showInfo('liquefaction')">â“˜</button>
    <span class="toggle" id="t-liquefaction"></span>
  </div>
  <div class="opacity-row" id="o-liquefaction"><input type="range" min="10" max="100" value="60" oninput="setOpacity('liquefaction',this.value)"><span class="opacity-val">60%</span></div>

  <div class="layer-row" onclick="toggleLayer('seismicRisk')">
    <span class="icon">ğŸ“Š</span><span class="name">åœ°ç›¤ã®æºã‚Œã‚„ã™ã•</span>
    <button class="info-btn" onclick="event.stopPropagation();showInfo('seismicRisk')">â“˜</button>
    <span class="toggle" id="t-seismicRisk"></span>
  </div>
  <div class="opacity-row" id="o-seismicRisk"><input type="range" min="10" max="100" value="50" oninput="setOpacity('seismicRisk',this.value)"><span class="opacity-val">50%</span></div>

  <div class="divider"></div>
  <div class="section-title">æ´ªæ°´è©³ç´°</div>
  <div class="layer-row" onclick="toggleLayer('floodDuration')">
    <span class="icon">â±</span><span class="name">æµ¸æ°´ç¶™ç¶šæ™‚é–“</span>
    <button class="info-btn" onclick="event.stopPropagation();showInfo('floodDuration')">â“˜</button>
    <span class="toggle" id="t-floodDuration"></span>
  </div>
  <div class="opacity-row" id="o-floodDuration"><input type="range" min="10" max="100" value="60" oninput="setOpacity('floodDuration',this.value)"><span class="opacity-val">60%</span></div>

  <div class="layer-row" onclick="toggleLayer('buildingCollapse')">
    <span class="icon">ğŸš</span><span class="name">å®¶å±‹å€’å£Šï¼ˆæ°¾æ¿«æµï¼‰</span>
    <button class="info-btn" onclick="event.stopPropagation();showInfo('buildingCollapse')">â“˜</button>
    <span class="toggle" id="t-buildingCollapse"></span>
  </div>
  <div class="opacity-row" id="o-buildingCollapse"><input type="range" min="10" max="100" value="60" oninput="setOpacity('buildingCollapse',this.value)"><span class="opacity-val">60%</span></div>

  <div class="layer-row" onclick="toggleLayer('bankErosion')">
    <span class="icon">ğŸš</span><span class="name">å®¶å±‹å€’å£Šï¼ˆæ²³å²¸ä¾µé£Ÿï¼‰</span>
    <button class="info-btn" onclick="event.stopPropagation();showInfo('bankErosion')">â“˜</button>
    <span class="toggle" id="t-bankErosion"></span>
  </div>
  <div class="opacity-row" id="o-bankErosion"><input type="range" min="10" max="100" value="60" oninput="setOpacity('bankErosion',this.value)"><span class="opacity-val">60%</span></div>

  <button class="btn-all btn-on" id="btn-toggle-all" onclick="toggleAll()">å…¨ã¦ ON</button>

  <div class="divider"></div>
  <div class="section-title">ç‰©ä»¶ãƒ”ãƒ³</div>
  <div class="legend-section">
    <div class="legend-row"><span class="legend-dot" style="background:#007AFF;"></span>ä¸­å¤ãƒãƒ³ã‚·ãƒ§ãƒ³</div>
    <div class="legend-row"><span class="legend-dot" style="background:#34C759;"></span>æ–°ç¯‰ãƒãƒ³ã‚·ãƒ§ãƒ³</div>
    <div class="legend-row"><span class="legend-dot" style="background:#007AFF;border:2px solid #FF3B30;"></span>ãŠæ°—ã«å…¥ã‚Š</div>
  </div>
  <div class="divider"></div>
  <div class="section-title">è¡¨ç¤ºè¨­å®š</div>
  <div class="layer-row" onclick="toggleBaseMap()">
    <span class="icon">ğŸ—º</span><span class="name">æ·¡è‰²åœ°å›³</span>
    <span class="toggle" id="t-basemap"></span>
  </div>
  <div style="padding:2px 16px 10px;font-size:10px;color:#8e8e93;line-height:1.4;">ãƒã‚¶ãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ã¯æ·¡è‰²åœ°å›³ã®æ–¹ãŒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒè¦‹ã‚„ã™ã„</div>
</div>

<!-- Floating active legend -->
<div class="active-legend" id="active-legend">
  <div class="al-title" onclick="this.parentElement.classList.toggle('collapsed')">è¡¨ç¤ºä¸­ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ <span class="toggle-btn">æŠ˜ã‚ŠãŸãŸã‚€</span></div>
  <div class="al-body">
    <div id="al-items"></div>
  </div>
  <div class="al-hint">åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚¶ãƒ¼ãƒ‰ç¢ºèª</div>
</div>

<div class="pin-count" id="pin-count">ç‰©ä»¶ 12ä»¶ è¡¨ç¤ºä¸­</div>

<script>
// === Map setup ===
const map = L.map('map', { zoomControl: false }).setView([35.6505, 139.7900], 14);
L.control.zoom({ position: 'bottomright' }).addTo(map);

const stdMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a>', maxZoom: 18
});
const paleMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">å›½åœŸåœ°ç†é™¢</a>', maxZoom: 18
});
paleMap.addTo(map);
let usingPale = true;
function toggleBaseMap() {
  if (usingPale) { map.removeLayer(paleMap); stdMap.addTo(map); }
  else { map.removeLayer(stdMap); paleMap.addTo(map); }
  usingPale = !usingPale;
  document.getElementById('t-basemap').classList.toggle('on', !usingPale);
}

// === Hazard layers ===
const hazardMeta = {
  flood:            { url: 'https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png', opacity: 0.6, icon: 'ğŸŒŠ', name: 'æ´ªæ°´æµ¸æ°´',    color: '#3D70C2' },
  inlandWater:      { url: 'https://disaportaldata.gsi.go.jp/raster/02_naisui_data/{z}/{x}/{y}.png',              opacity: 0.6, icon: 'ğŸ’§', name: 'å†…æ°´æµ¸æ°´',    color: '#66BAD9' },
  sediment:         { url: 'https://disaportaldata.gsi.go.jp/raster/05_dosekiryukeikaikuiki/{z}/{x}/{y}.png',     opacity: 0.6, icon: 'â›°',  name: 'åœŸç ‚ç½å®³',    color: '#E6A817' },
  stormSurge:       { url: 'https://disaportaldata.gsi.go.jp/raster/03_hightide_l2_shinsuishin_data/{z}/{x}/{y}.png', opacity: 0.6, icon: 'ğŸŒŠ', name: 'é«˜æ½®æµ¸æ°´', color: '#943D94' },
  tsunami:          { url: 'https://disaportaldata.gsi.go.jp/raster/04_tsunami_newlegend_data/{z}/{x}/{y}.png',   opacity: 0.6, icon: 'ğŸŒŠ', name: 'æ´¥æ³¢æµ¸æ°´',    color: '#5B3DA4' },
  liquefaction:     { url: 'https://cyberjapandata.gsi.go.jp/xyz/lcmfc2/{z}/{x}/{y}.png',                         opacity: 0.6, icon: 'ã€°',  name: 'æ¶²çŠ¶åŒ–(åœ°å½¢åˆ†é¡)',  color: '#F58C4D' },
  seismicRisk:      { url: 'https://cyberjapandata.gsi.go.jp/xyz/lcmfc2/{z}/{x}/{y}.png',                         opacity: 0.5, icon: 'ğŸ“Š', name: 'æºã‚Œã‚„ã™ã•(åœ°å½¢åˆ†é¡)', color: '#E63333' },
  floodDuration:    { url: 'https://disaportaldata.gsi.go.jp/raster/01_flood_l2_keizoku_data/{z}/{x}/{y}.png',    opacity: 0.6, icon: 'â±',  name: 'æµ¸æ°´ç¶™ç¶š',    color: '#3D70C2' },
  buildingCollapse: { url: 'https://disaportaldata.gsi.go.jp/raster/01_flood_l2_kaokutoukai_hanran_data/{z}/{x}/{y}.png', opacity: 0.6, icon: 'ğŸš', name: 'å®¶å±‹å€’å£Š(æ°¾)', color: '#E63333' },
  bankErosion:      { url: 'https://disaportaldata.gsi.go.jp/raster/01_flood_l2_kaokutoukai_kagan_data/{z}/{x}/{y}.png', opacity: 0.6, icon: 'ğŸš', name: 'å®¶å±‹å€’å£Š(æ²³)', color: '#CC4444' },
};

const hazardLayers = {};
const layerState = {};
for (const [key, cfg] of Object.entries(hazardMeta)) {
  hazardLayers[key] = L.tileLayer(cfg.url, { opacity: cfg.opacity, maxZoom: 18, attribution: 'å›½åœŸåœ°ç†é™¢ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—' });
  layerState[key] = false;
}

function toggleLayer(key) {
  layerState[key] = !layerState[key];
  if (layerState[key]) hazardLayers[key].addTo(map);
  else map.removeLayer(hazardLayers[key]);
  document.getElementById('t-' + key).classList.toggle('on', layerState[key]);
  document.getElementById('o-' + key).classList.toggle('show', layerState[key]);
  updateAllButton();
  updateActiveLegend();
}

function setOpacity(key, val) {
  const v = parseInt(val);
  hazardLayers[key].setOpacity(v / 100);
  document.querySelector(`#o-${key} .opacity-val`).textContent = v + '%';
}

function toggleAll() {
  const anyOn = Object.values(layerState).some(v => v);
  const newState = !anyOn;
  for (const key of Object.keys(layerState)) {
    layerState[key] = newState;
    if (newState) hazardLayers[key].addTo(map);
    else map.removeLayer(hazardLayers[key]);
    document.getElementById('t-' + key).classList.toggle('on', newState);
    document.getElementById('o-' + key).classList.toggle('show', newState);
  }
  updateAllButton();
  updateActiveLegend();
}

function updateAllButton() {
  const anyOn = Object.values(layerState).some(v => v);
  const btn = document.getElementById('btn-toggle-all');
  btn.textContent = anyOn ? 'å…¨ã¦ OFF' : 'å…¨ã¦ ON';
  btn.className = 'btn-all ' + (anyOn ? 'btn-off' : 'btn-on');
}

// === Active layer legend ===
function updateActiveLegend() {
  const container = document.getElementById('al-items');
  const wrapper = document.getElementById('active-legend');
  const activeKeys = Object.keys(layerState).filter(k => layerState[k]);
  if (activeKeys.length === 0) { wrapper.classList.remove('show'); return; }
  wrapper.classList.add('show');
  container.innerHTML = activeKeys.map(k => {
    const m = hazardMeta[k];
    return `<div class="al-item" onclick="showInfo('${k}')">
      <span class="al-swatch" style="background:${m.color};"></span>
      <span>${m.icon} ${m.name}</span>
    </div>`;
  }).join('');
}

// === Click to identify hazards ===
map.on('click', function(e) {
  const activeKeys = Object.keys(layerState).filter(k => layerState[k]);
  if (activeKeys.length === 0) return;

  // Check which layers have tile data at clicked point by loading tile pixels
  const zoom = map.getZoom();
  const point = map.project(e.latlng, zoom);
  const tileSize = 256;
  const tileX = Math.floor(point.x / tileSize);
  const tileY = Math.floor(point.y / tileSize);
  const pixelX = Math.floor(point.x % tileSize);
  const pixelY = Math.floor(point.y % tileSize);

  let results = [];
  let pending = activeKeys.length;

  activeKeys.forEach(key => {
    const cfg = hazardMeta[key];
    const tileUrl = cfg.url.replace('{z}', zoom).replace('{x}', tileX).replace('{y}', tileY);
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.width = tileSize; canvas.height = tileSize;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      try {
        const pixel = ctx.getImageData(pixelX, pixelY, 1, 1).data;
        // If alpha > 10 the layer has data here
        if (pixel[3] > 10) {
          results.push({ key, meta: cfg, r: pixel[0], g: pixel[1], b: pixel[2], a: pixel[3] });
        }
      } catch(ex) {
        // CORS blocked, assume layer has data if ON
        results.push({ key, meta: cfg, r: 0, g: 0, b: 0, a: 255 });
      }
      pending--;
      if (pending === 0) showHazardIdPopup(e.latlng, results);
    };
    img.onerror = function() {
      // No tile = no data at this location
      pending--;
      if (pending === 0) showHazardIdPopup(e.latlng, results);
    };
    img.src = tileUrl;
  });
});

function showHazardIdPopup(latlng, results) {
  let html = '<div class="hazard-id-popup">';
  html += '<div class="hid-title">ã“ã®åœ°ç‚¹ã®ãƒã‚¶ãƒ¼ãƒ‰</div>';
  if (results.length === 0) {
    html += '<div class="hid-none">è©²å½“ã™ã‚‹ãƒã‚¶ãƒ¼ãƒ‰ãªã—</div>';
  } else {
    results.forEach(r => {
      const bgColor = `rgba(${r.r},${r.g},${r.b},0.15)`;
      const textColor = r.meta.color;
      html += `<span class="hid-chip" style="background:${bgColor};color:${textColor};">${r.meta.icon} ${r.meta.name}</span>`;
    });
    html += `<div style="font-size:9px;color:#999;margin-top:6px;">${results.length}ç¨®é¡ã®ãƒã‚¶ãƒ¼ãƒ‰ãŒé‡ãªã£ã¦ã„ã¾ã™</div>`;
  }
  html += '</div>';
  L.popup({ maxWidth: 260, closeButton: true })
    .setLatLng(latlng)
    .setContent(html)
    .openOn(map);
}

// === Sample properties ===
const properties = [
  { name: 'ãƒ‘ãƒ¼ã‚¯ã‚·ãƒ†ã‚£è±Šæ´² Bæ£Ÿ', lat: 35.6553, lng: 139.7938, type: 'chuko', liked: true, price: '8,980ä¸‡å††', layout: '3LDK', area: '72.5ã¡', walk: 'å¾’æ­©4åˆ†', age: 'ç¯‰18å¹´' },
  { name: 'ãƒ–ãƒªãƒªã‚¢ã‚¿ãƒ¯ãƒ¼æ±äº¬', lat: 35.6485, lng: 139.7850, type: 'chuko', liked: false, price: '7,480ä¸‡å††', layout: '2LDK', area: '61.2ã¡', walk: 'å¾’æ­©6åˆ†', age: 'ç¯‰12å¹´' },
  { name: 'ãƒ—ãƒ©ã‚¦ãƒ‰æ–‡äº¬å°çŸ³å·', lat: 35.7130, lng: 139.7440, type: 'chuko', liked: false, price: '9,500ä¸‡å††', layout: '3LDK', area: '68.0ã¡', walk: 'å¾’æ­©3åˆ†', age: 'ç¯‰5å¹´' },
  { name: 'ã‚¶ãƒ»ãƒ‘ãƒ¼ã‚¯ãƒã‚¦ã‚¹æ™´æµ·', lat: 35.6560, lng: 139.7820, type: 'chuko', liked: true, price: '6,280ä¸‡å††', layout: '2LDK', area: '55.3ã¡', walk: 'å¾’æ­©7åˆ†', age: 'ç¯‰8å¹´' },
  { name: 'ã‚·ãƒ†ã‚£ã‚¿ãƒ¯ãƒ¼æœ‰æ˜', lat: 35.6380, lng: 139.7890, type: 'chuko', liked: false, price: '5,980ä¸‡å††', layout: '2LDK', area: '58.1ã¡', walk: 'å¾’æ­©5åˆ†', age: 'ç¯‰10å¹´' },
  { name: 'ã‚°ãƒ©ãƒ³ãƒ‰ãƒ¡ã‚¾ãƒ³å“å·ã‚·ãƒ¼ã‚µã‚¤ãƒ‰', lat: 35.6090, lng: 139.7490, type: 'chuko', liked: false, price: '7,280ä¸‡å††', layout: '3LDK', area: '70.2ã¡', walk: 'å¾’æ­©3åˆ†', age: 'ç¯‰15å¹´' },
  { name: 'HARUMI FLAG SUN VILLAGE', lat: 35.6460, lng: 139.7830, type: 'shinchiku', liked: true, price: '6,000ä¸‡ã€œ1.2å„„', layout: '2LDKã€œ4LDK', area: '61ã€œ100ã¡', walk: 'å¾’æ­©12åˆ†', age: '2025å¹´å…¥å±…' },
  { name: 'ãƒ–ãƒ©ãƒ³ã‚ºã‚¿ãƒ¯ãƒ¼è±Šæ´²', lat: 35.6530, lng: 139.7960, type: 'shinchiku', liked: false, price: '7,500ä¸‡ã€œ1.5å„„', layout: '1LDKã€œ4LDK', area: '42ã€œ86ã¡', walk: 'å¾’æ­©5åˆ†', age: '2026å¹´å…¥å±…' },
  { name: 'ãƒ‘ãƒ¼ã‚¯ã‚¿ãƒ¯ãƒ¼å‹ã©ã', lat: 35.6588, lng: 139.7760, type: 'shinchiku', liked: false, price: '8,000ä¸‡ã€œ2å„„', layout: '1LDKã€œ3LDK', area: '44ã€œ82ã¡', walk: 'å¾’æ­©1åˆ†', age: '2025å¹´å…¥å±…' },
  { name: 'ã‚¶ãƒ»ã‚¿ãƒ¯ãƒ¼æ¨ªæµœåŒ—ä»²', lat: 35.6520, lng: 139.7750, type: 'chuko', liked: false, price: '8,500ä¸‡å††', layout: '2LDK', area: '65.0ã¡', walk: 'å¾’æ­©3åˆ†', age: 'ç¯‰7å¹´' },
  { name: 'ãƒ—ãƒ©ã‚¦ãƒ‰ã‚¿ãƒ¯ãƒ¼æ±é›²', lat: 35.6410, lng: 139.8010, type: 'chuko', liked: false, price: '6,700ä¸‡å††', layout: '3LDK', area: '75.3ã¡', walk: 'å¾’æ­©8åˆ†', age: 'ç¯‰11å¹´' },
  { name: 'ã‚¹ã‚«ã‚¤ã‚ºã‚¿ãƒ¯ãƒ¼&ã‚¬ãƒ¼ãƒ‡ãƒ³', lat: 35.6350, lng: 139.7950, type: 'chuko', liked: true, price: '7,800ä¸‡å††', layout: '3LDK', area: '80.1ã¡', walk: 'å¾’æ­©10åˆ†', age: 'ç¯‰9å¹´' },
];

function createIcon(type, liked) {
  const color = type === 'shinchiku' ? '#34C759' : '#007AFF';
  const border = liked ? 'border: 2px solid #FF3B30;' : '';
  const size = liked ? '28px' : '24px';
  return L.divIcon({
    className: '',
    html: `<div style="width:${size};height:${size};border-radius:50%;background:${color};${border}display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.3);cursor:pointer;">
      <span style="color:#fff;font-size:10px;font-weight:700;">${type === 'shinchiku' ? 'âœ¨' : 'ğŸ¢'}</span>
    </div>`,
    iconSize: [parseInt(size), parseInt(size)],
    iconAnchor: [parseInt(size)/2, parseInt(size)/2],
  });
}

properties.forEach(p => {
  const marker = L.marker([p.lat, p.lng], { icon: createIcon(p.type, p.liked) });
  const likeIcon = p.liked ? 'â™¥' : 'â™¡';
  const likeColor = p.liked ? '#FF3B30' : '#ccc';
  marker.bindPopup(`
    <div style="font-family:-apple-system,sans-serif;min-width:200px;">
      <div style="display:flex;align-items:flex-start;gap:6px;">
        <div style="font-size:14px;font-weight:700;flex:1;line-height:1.3;">${p.name}</div>
        <span style="color:${likeColor};font-size:18px;flex-shrink:0;">${likeIcon}</span>
      </div>
      <div style="font-size:14px;font-weight:700;color:${p.type==='shinchiku'?'#34C759':'#007AFF'};margin:4px 0;">${p.price}</div>
      <div style="font-size:11px;color:#666;line-height:1.6;">${p.layout} ãƒ» ${p.area} ãƒ» ${p.walk}<br>${p.age}</div>
    </div>
  `, { maxWidth: 280, closeButton: true });
  marker.addTo(map);
});

document.getElementById('pin-count').textContent = `ç‰©ä»¶ ${properties.length}ä»¶ è¡¨ç¤ºä¸­`;

// === Layer info data ===
const layerInfo = {
  flood:            { icon: 'ğŸŒŠ', title: 'æ´ªæ°´æµ¸æ°´æƒ³å®š', desc: 'æ²³å·ãŒæ°¾æ¿«ã—ãŸå ´åˆã«æƒ³å®šã•ã‚Œã‚‹æµ¸æ°´ã®æ·±ã•ã€‚æƒ³å®šæœ€å¤§è¦æ¨¡ã®é™é›¨ï¼ˆ1000å¹´ã«1å›ç¨‹åº¦ï¼‰ã«åŸºã¥ãã€‚', legend: [{color:'#F5F597',label:'0.5mæœªæº€'},{color:'#A6DEDD',label:'0.5ã€œ3m'},{color:'#66BAD9',label:'3ã€œ5m'},{color:'#3D70C2',label:'5ã€œ10m'},{color:'#943D94',label:'10ã€œ20m'}]},
  inlandWater:      { icon: 'ğŸ’§', title: 'å†…æ°´æµ¸æ°´æƒ³å®š', desc: 'ä¸‹æ°´é“ç­‰ã®æ’æ°´èƒ½åŠ›ã‚’è¶…ãˆã‚‹é™é›¨æ™‚ã®æµ¸æ°´æƒ³å®šã€‚ã„ã‚ã‚†ã‚‹éƒ½å¸‚å‹æ°´å®³ã€‚', legend: [{color:'#F5F597',label:'0.5mæœªæº€'},{color:'#66BAD9',label:'0.5ã€œ1m'},{color:'#3D70C2',label:'1ã€œ3m'},{color:'#943D94',label:'3mä»¥ä¸Š'}]},
  sediment:         { icon: 'â›°', title: 'åœŸç ‚ç½å®³è­¦æˆ’', desc: 'åœŸçŸ³æµãƒ»åœ°ã™ã¹ã‚Šãƒ»æ€¥å‚¾æ–œåœ°ã®å´©å£Šãƒªã‚¹ã‚¯åŒºåŸŸã€‚', legend: [{color:'#FFD700',label:'è­¦æˆ’åŒºåŸŸï¼ˆã‚¤ã‚¨ãƒ­ãƒ¼ï¼‰'},{color:'#FF0000',label:'ç‰¹åˆ¥è­¦æˆ’åŒºåŸŸï¼ˆãƒ¬ãƒƒãƒ‰ï¼‰'}]},
  stormSurge:       { icon: 'ğŸŒŠ', title: 'é«˜æ½®æµ¸æ°´æƒ³å®š', desc: 'å°é¢¨ç­‰ã«ã‚ˆã‚‹é«˜æ½®ã®æµ¸æ°´æƒ³å®šã€‚æ±äº¬æ¹¾å²¸ã¯åºƒç¯„å›²ã§è©²å½“ã€‚', legend: [{color:'#F5F597',label:'0.5mæœªæº€'},{color:'#A6DEDD',label:'0.5ã€œ3m'},{color:'#66BAD9',label:'3ã€œ5m'},{color:'#3D70C2',label:'5ã€œ10m'},{color:'#943D94',label:'10mä»¥ä¸Š'}]},
  tsunami:          { icon: 'ğŸŒŠ', title: 'æ´¥æ³¢æµ¸æ°´æƒ³å®š', desc: 'æœ€å¤§ã‚¯ãƒ©ã‚¹ã®æ´¥æ³¢ã§æƒ³å®šã•ã‚Œã‚‹æµ¸æ°´ã®æ·±ã•ã€‚', legend: [{color:'#F5F597',label:'0.3mæœªæº€'},{color:'#A6DEDD',label:'0.3ã€œ1m'},{color:'#66BAD9',label:'1ã€œ2m'},{color:'#3D70C2',label:'2ã€œ5m'},{color:'#943D94',label:'5mä»¥ä¸Š'}]},
  liquefaction:     { icon: 'ã€°', title: 'æ¶²çŠ¶åŒ–ãƒªã‚¹ã‚¯', desc: 'åœ°éœ‡æ™‚ã®åœ°ç›¤æ¶²çŠ¶åŒ–ãƒªã‚¹ã‚¯ã€‚åŸ‹ç«‹åœ°ãƒ»æ²³å·æ²¿ã„ã§é«˜ãƒªã‚¹ã‚¯ã€‚', legend: [{color:'#8CD18C',label:'å¯èƒ½æ€§ ä½'},{color:'#F5E066',label:'å¯èƒ½æ€§ ä¸­'},{color:'#F58C4D',label:'å¯èƒ½æ€§ é«˜'},{color:'#E63333',label:'å¯èƒ½æ€§ æ¥µé«˜'}]},
  seismicRisk:      { icon: 'ğŸ“Š', title: 'åœ°ç›¤ã®æºã‚Œã‚„ã™ã•', desc: 'è¡¨å±¤åœ°ç›¤å¢—å¹…ç‡ã€‚å¤§ãã„ã»ã©æºã‚ŒãŒå¢—å¹…ã€‚', legend: [{color:'#8CD18C',label:'å¢—å¹…ç‡ ä½ã„'},{color:'#F5E066',label:'ã‚„ã‚„å¤§'},{color:'#F58C4D',label:'å¤§ãã„'},{color:'#E63333',label:'éå¸¸ã«å¤§'}]},
  floodDuration:    { icon: 'â±', title: 'æµ¸æ°´ç¶™ç¶šæ™‚é–“', desc: 'æ²³å·æ°¾æ¿«å¾Œã®æµ¸æ°´ç¶™ç¶šæ™‚é–“æƒ³å®šã€‚', legend: [{color:'#F5F597',label:'12æ™‚é–“æœªæº€'},{color:'#A6DEDD',label:'1æ—¥æœªæº€'},{color:'#66BAD9',label:'3æ—¥æœªæº€'},{color:'#3D70C2',label:'1é€±é–“æœªæº€'},{color:'#943D94',label:'2é€±é–“ä»¥ä¸Š'}]},
  buildingCollapse: { icon: 'ğŸš', title: 'å®¶å±‹å€’å£Šï¼ˆæ°¾æ¿«æµï¼‰', desc: 'æ°¾æ¿«æµã§å®¶å±‹ãŒå€’å£Šã™ã‚‹ãŠãã‚ŒãŒã‚ã‚‹åŒºåŸŸã€‚', legend: [{color:'#E63333',label:'å€’å£Šå±é™ºåŒºåŸŸ'}]},
  bankErosion:      { icon: 'ğŸš', title: 'å®¶å±‹å€’å£Šï¼ˆæ²³å²¸ä¾µé£Ÿï¼‰', desc: 'æ²³å²¸ä¾µé£Ÿã§å®¶å±‹ãŒå€’å£Šãƒ»æµå‡ºã™ã‚‹ãŠãã‚ŒãŒã‚ã‚‹åŒºåŸŸã€‚', legend: [{color:'#E63333',label:'å€’å£Šå±é™ºåŒºåŸŸ'}]},
};

function showInfo(key) {
  const info = layerInfo[key]; if (!info) return;
  document.querySelectorAll('.info-overlay,.info-popup').forEach(e => e.remove());
  const overlay = document.createElement('div');
  overlay.className = 'info-overlay';
  overlay.onclick = () => { overlay.remove(); popup.remove(); };
  document.body.appendChild(overlay);
  const popup = document.createElement('div');
  popup.className = 'info-popup';
  popup.innerHTML = `
    <button class="close-btn" onclick="this.parentElement.remove();document.querySelector('.info-overlay')?.remove();">âœ•</button>
    <h4>${info.icon} ${info.title}</h4>
    <div class="desc">${info.desc}</div>
    <div class="legend-title">å‡¡ä¾‹ï¼ˆè‰²ã¨ãƒªã‚¹ã‚¯ã®å¯¾å¿œï¼‰</div>
    ${info.legend.map(l => `<div class="legend-item"><span class="legend-swatch" style="background:${l.color};"></span>${l.label}</div>`).join('')}
    <div class="source">å‡ºå…¸: å›½åœŸåœ°ç†é™¢ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆ</div>
  `;
  document.body.appendChild(popup);
}

// === URL parameter support ===
function enableLayers(keys) {
  for (const k of Object.keys(layerState)) {
    if (layerState[k]) { map.removeLayer(hazardLayers[k]); layerState[k] = false; }
    document.getElementById('t-' + k).classList.remove('on');
    document.getElementById('o-' + k).classList.remove('show');
  }
  for (const k of keys) {
    if (hazardLayers[k]) {
      layerState[k] = true; hazardLayers[k].addTo(map);
      document.getElementById('t-' + k).classList.add('on');
      document.getElementById('o-' + k).classList.add('show');
    }
  }
  updateAllButton(); updateActiveLegend();
}
const presets = {
  all: Object.keys(hazardMeta),
  basic: ['flood','inlandWater','sediment','stormSurge','tsunami','liquefaction'],
  flood_only: ['flood'], storm_only: ['stormSurge'], tsunami_only: ['tsunami'],
  liquefaction_only: ['liquefaction'], seismic_only: ['seismicRisk'],
  flood_detail: ['flood','floodDuration','buildingCollapse','bankErosion'],
};
const params = new URLSearchParams(window.location.search);
const preset = params.get('preset');
if (preset && presets[preset]) setTimeout(() => enableLayers(presets[preset]), 500);
else if (params.get('layers')) setTimeout(() => enableLayers(params.get('layers').split(',')), 500);
</script>
</body>
</html>
