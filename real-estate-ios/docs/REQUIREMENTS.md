# 物件情報 iOS アプリ 要件定義

## 1. 概要

スクレイピング（SUUMO/HOME'S）で取得した**中古マンション**および**新築マンション**を**1つの iOS アプリ**で閲覧する。アプリ内に物件 DB（SwiftData）を持ち、新規物件追加時に**アプリ内通知**で知らせる。Notion・Slack は本アプリでは連携しない。HIG・OOUI・iOS 26 Liquid Glass に則った軽量で見やすいアプリを目指す。

---

## 2. 方針（確定）

| 項目 | 決定 |
|------|------|
| **データ取得** | 中古・新築それぞれの JSON URL（GitHub raw 等）から取得。DB はアプリ内のみ。詳細は [DB-STRATEGY.md](DB-STRATEGY.md) 参照。 |
| **プッシュ通知** | **ローカル通知**（BGAppRefreshTask）+ **リモートプッシュ通知**（FCM via GitHub Actions）。GitHub Actions でスクレイピング後、新着があれば FCM HTTP v1 API でトピック `new_listings` にプッシュ。 |
| **Notion** | 本アプリでは**連携しない**。Notion は別物として扱い、DB 機能はアプリに寄せる。 |
| **Slack** | 本アプリでは**連携しない**。アプリから通知できれば十分。 |
| **対象** | iOS 17 以降。iPad は対象外（iPhone のみ）。 |
| **ユーザー** | 自分用。家族だけインストールできる配布（TestFlight 等）を想定。 |
| **デザイン** | Human Interface Guidelines（HIG）・OOUI に厳密に則る。iOS 26 では Liquid Glass デザインシステムに対応し、iOS 17–25 では既存のシステムスタイルにフォールバック。 |
| **共有** | いいね・メモは **Firebase Firestore** で家族間共有。**Google サインイン**認証。[セットアップ手順](FIREBASE-SETUP.md) 参照。 |
| **物件種別** | **中古マンション**と**新築マンション**の両方をサポート。ボトムタブで分離。 |
| **地図** | **MapKit** で物件ピン表示。ハザードマップ（国土地理院タイル全種）・地域危険度（東京都）をオーバーレイ。 |

---

## 3. 機能要件

### 3.1 必須（実装済み）

- **物件一覧（中古）**: アプリ内 DB に保存された中古物件を一覧表示。
- **ソート**: 追加日（新しい順）、価格（安い順/高い順）、徒歩（近い順）、広さ（広い順）。
- **フィルタ**: 価格（範囲）、間取り（複数選択）、駅（路線別・複数選択）、駅徒歩（分以内）、専有面積（㎡以上）、権利形態（所有権/定期借地チェックボックス）。
- **物件詳細**: 1件タップで詳細表示。外部ブラウザで SUUMO/HOME'S 詳細を開く。
- **いいね**: 各物件をいいね/解除。一覧・詳細・地図どこからでも操作可能。
- **メモ**: 各物件にテキストメモを付与・編集。
- **お気に入りタブ**: いいね済みの物件だけを表示する専用タブ。
- **新規物件のプッシュ通知**: 新規追加があったときにローカル通知で知らせる。
- **バックグラウンド自動取得**: BGAppRefreshTask で定期的に JSON を取得し、新着検出→通知。
- **データの同期**: 手動（更新ボタン/pull-to-refresh）で最新の物件リストを取得し、ローカル DB を更新。
- **いいね・メモの家族間共有**: Firebase Firestore で同期。
- **テキスト検索（F1）**: 物件名でのインクリメンタル検索（`.searchable` モディファイア）。
- **駅名フィルタ（F2）**: FilterSheet 内の駅名アコーディオン、路線別に駅名チップで複数選択可能。
- **物件比較（F3）**: ツールバーから比較モード起動、最大4件の横並び比較（`ComparisonView`）。
- **CSVエクスポート（F5）**: お気に入りタブで ShareLink による CSV エクスポート。
- **共有フィルタ（U2）**: FilterStore による全タブ（中古・新築・地図・お気に入り）でのフィルタ状態共有。
- **現在地表示（U4）**: 地図タブ左下の現在地ボタン（CLLocationManager）で現在地へ移動・中心表示。
- **改善された空状態（U5）**: 「今すぐ更新」ボタン付き空状態画面で初回ユーザーを誘導。
- **HH:mm表記（U6）**: 更新時刻を `HH:mm` 形式で表示。

### 3.2 新規追加

- **物件一覧（新築）**: 新築マンションの一覧を専用タブで表示。棟単位の情報（価格帯・間取り幅・面積幅・引渡時期）。
- **新築/中古タブ分離**: ボトムタブで「中古」「新築」「地図」「お気に入り」「設定」に分離。
- **地図タブ**: MapKit で全物件（新築+中古）をピン表示。
  - ピンタップ → ポップアップ（物件概要 + いいねボタン）→ タップで詳細画面遷移。
  - 中古一覧と同じフィルタ条件でフィルタ可能。
  - 新築/中古を色分けして両方表示。
- **ハザードマップオーバーレイ**: 国土地理院 WMS タイルを地図に重ねる。
  - 基本: 洪水浸水想定、内水浸水想定、土砂災害警戒区域、高潮浸水想定、津波浸水想定、液状化リスク。
  - 洪水詳細: 浸水継続時間、家屋倒壊（氾濫流）、家屋倒壊（河岸侵食）。
  - レイヤーの表示/非表示切替。
- **地域危険度オーバーレイ（GSI）**: 国土地理院配信の地盤振動タイル。
- **地域危険度オーバーレイ（東京都）**: 東京都都市整備局の地域危険度データ（建物倒壊、火災、総合）を GeoJSON → MKPolygon でランク 1-5 色分け表示。
- **リモートプッシュ通知**: FCM (Firebase Cloud Messaging) を GitHub Actions から直接送信。トピック `new_listings` を購読し、スクレイピングで新着検出時にプッシュ。

### 3.3 一覧に表示する情報

#### 中古マンション
- 物件名、価格、間取り、専有面積、駅徒歩
- 築年数、階数/階建て、所有権/定借、総戸数
- 路線・駅名
- メモ（あれば1行プレビュー）、いいねアイコン

#### 新築マンション
- 物件名、価格帯（○万円台〜○万円台）、間取り幅、面積幅、駅徒歩
- 引渡時期、総戸数
- 路線・駅名
- メモ（あれば1行プレビュー）、いいねアイコン

### 3.4 あるとよい（未実装）

- カラースキームのカスタマイズ（4案検討中、[プレビュー](../color-preview/index.html)）。

---

## 4. 非機能要件

- **軽い**: 起動が速く、一覧スクロールがスムーズ。
- **見やすい**: 情報密度を抑え、フォント・余白・階層を整理した UI。
- **オフライン**: 一度取得した一覧はオフラインでも閲覧可能（詳細 URL はオンライン時のみ開く）。

---

## 5. データ

### 5.1 中古マンション（`latest.json`）
- 既存フォーマット準拠。`property_type: "chuko"` を追加。
- `name`, `url`, `address`, `price_man`, `area_m2`, `layout`, `built_year`, `station_line`, `walk_min`, `floor_position`, `floor_total`, `total_units`, `ownership`, `source`, `list_ward_roman` など。

### 5.2 新築マンション（`latest_shinchiku.json`）
- 中古と同じキー + 新築固有のキーを追加。
- `property_type: "shinchiku"`
- `price_max_man`: 価格帯上限（万円、null = 単一価格 or 価格未定）
- `area_max_m2`: 面積幅上限（㎡、null = 単一面積）
- `delivery_date`: 引渡時期（文字列、例: "2027年9月上旬予定"）

### 5.3 共通
- 新規判定は `identity_key` ベース。
- ユーザーデータ（`isLiked`, `memo`, `addedAt`）はローカル SwiftData + Firebase Firestore で管理。同期時に JSON 由来の値で上書きしない。

---

## 6. 想定アーキテクチャ

- **アプリ**: SwiftUI、SwiftData でローカル永続化。タブ構成: 中古一覧・新築一覧・地図・お気に入り・設定。HIG・OOUI・Liquid Glass（iOS 26）／Material フォールバック（iOS 17–25）。
- **データ同期**: 設定で保存した一覧 JSON の URL（中古用・新築用）から取得し、SwiftData を更新。同一物件は `identityKey` でマッチして更新、新規は挿入、一覧から消えたものはローカルから削除。
- **通知**: BGAppRefreshTask でバックグラウンド自動取得（約30分間隔、OS判断）+ FCM リモートプッシュ通知（GitHub Actions → FCM HTTP v1 API → トピック送信）。
- **共有**: Firebase Firestore（Google サインイン認証）。いいね・メモを `annotations` コレクションに保存。
- **地図**: MapKit + MKTileOverlay（国土地理院ハザードタイル 10 種）+ MKPolygon（東京都地域危険度 GeoJSON）+ CLGeocoder / MapKit ジオコーディング。
- **スクレイピング**: SUUMO + HOME'S の中古・新築を GitHub Actions で日次取得。`latest.json`（中古）と `latest_shinchiku.json`（新築）に分離出力。

---

## 7. ドキュメント一覧

| ファイル | 内容 |
|---------|------|
| [REQUIREMENTS.md](REQUIREMENTS.md) | 本ファイル。要件定義。 |
| [DB-STRATEGY.md](DB-STRATEGY.md) | ローカル DB（SwiftData）の設計と同期戦略。 |
| [DESIGN.md](DESIGN.md) | HIG・OOUI・Liquid Glass のデザイン指針。 |
| [FIREBASE-SETUP.md](FIREBASE-SETUP.md) | Firebase プロジェクトのセットアップ手順。 |
| [TODO.md](TODO.md) | 未確定事項・次回作業の TODO。 |

---

## 8. 用語

- **listing**: 物件 1 件のデータ。
- **identity_key**: 名前・間取り・専有面積・住所・築年・路線・徒歩で一意化するキー（価格は含めない）。
- **新規**: 前回取得リストに identity_key が存在しなかった物件。
- **annotation**: いいね・メモのユーザーデータ。Firebase Firestore で家族間共有。
- **property_type**: `"chuko"`（中古）または `"shinchiku"`（新築）。
- **hazard overlay**: 国土地理院のハザードマップタイルを地図に重畳表示するレイヤー。

---

## オフライン動作

| 画面 | オフライン時の挙動 |
|---|---|
| **一覧（中古/新築）** | SwiftData にキャッシュされた最新データを表示。更新ボタン・Pull-to-refresh は「オフラインのため取得できません。接続を確認してください。」エラー。 |
| **お気に入り** | ローカル SwiftData から表示（いいね・コメントはローカル保存済み）。Firestore 同期は次回オンライン時に実行。 |
| **地図** | キャッシュ済みの物件ピンを表示。ハザードマップタイルは MapKit のキャッシュに依存（未キャッシュ分は非表示）。 |
| **設定** | 全項目表示可能。フルリフレッシュは上記エラーを返す。 |
| **詳細** | ローカルデータで表示。外部リンク（SUUMO/HOME'S）はブラウザがオフラインエラーを表示。 |
| **通勤時間** | 経路計算に MKDirections（ネットワーク必須）を使うため、オフライン時は計算不可。既にキャッシュ済みの経路は表示可能。 |

### ETag キャッシュ

- サーバーから `ETag` ヘッダーを受信した場合は `UserDefaults` に保存
- 次回リクエスト時に `If-None-Match` ヘッダーで送信
- サーバーが `304 Not Modified` を返した場合はダウンロードをスキップ（通信量削減）
- 「フルリフレッシュ」は ETag をクリアして全件再取得

---

## アクセシビリティ対応

| 項目 | 対応状況 |
|---|---|
| **Dynamic Type** | 全画面でシステムフォントスタイル（`.headline`, `.subheadline`, `.caption` 等）を使用。ハードコードサイズなし。 |
| **VoiceOver** | 一覧行に `accessibilityLabel`（物件名・価格・面積・徒歩）を設定。ボタン類に `accessibilityLabel` を付与。 |
| **色のコントラスト** | セマンティックカラー（`.primary`, `.secondary`, `.accentColor`）を使用し、ライトモード/ダークモードで自動調整。 |
| **ボタンサイズ** | タップターゲットは最小 44pt を目安に設定。 |
| **操作ヒント** | 一覧行に `accessibilityHint` を設定（「タップで詳細。ハートでいいね」）。 |

---

## パフォーマンス

| 処理 | 最適化手法 |
|---|---|
| **データ取得** | 中古/新築の HTTP リクエストを `async let` で並列実行（ネットワーク待ちを半減） |
| **JSON デコード** | `Task.detached(priority: .userInitiated)` でバックグラウンドスレッドに移動（UI フリーズ防止） |
| **DB 同期** | `identityKey → Listing` の Dictionary で O(1) ルックアップ（既存 O(N*M) → O(N+M)） |
| **GeoJSON** | バックグラウンドスレッドでデコード |
| **DateFormatter** | `static let` で使い回し（毎回生成を回避） |
| **二重更新防止** | `guard !isRefreshing` で同時リフレッシュをガード |
| **ETag** | 304 Not Modified でダウンロード自体をスキップ |