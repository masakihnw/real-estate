# 物件情報アプリ 総合仕様書

> **最終更新**: 2026-02-14  
> **ステータス**: 運用中  
> **リポジトリ**: https://github.com/masakihnw/real-estate

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [システムアーキテクチャ](#2-システムアーキテクチャ)
3. [iOS アプリ仕様](#3-ios-アプリ仕様)
4. [画面別機能一覧](#4-画面別機能一覧)
5. [スクレイピングツール仕様](#5-スクレイピングツール仕様)
6. [データモデル](#6-データモデル)
7. [Firebase 仕様](#7-firebase-仕様)
8. [CI/CD パイプライン](#8-cicd-パイプライン)
9. [購入条件・フィルタロジック](#9-購入条件フィルタロジック)
10. [非機能要件](#10-非機能要件)
11. [用語集](#11-用語集)

---

## 1. プロジェクト概要

### 1.1 目的

10年住み替え前提で「インデックス（年5%）に勝つ」ための中古・新築マンション購入を検討するためのツール群。SUUMO / HOME'S から物件情報を自動スクレイピングし、iOS アプリで閲覧・比較・評価を行う。

### 1.2 ターゲットユーザー

- 自分自身 + 家族（妻）
- TestFlight による限定配布
- Google サインインのメールアドレスホワイトリストで制御

### 1.3 プロジェクト構成

```
real-estate/
├── .github/workflows/         # CI/CD（GitHub Actions）
├── docs/                      # 購入条件・相談メモ・本仕様書
├── firebase.json              # Firebase 設定
├── firestore.rules            # Firestore セキュリティルール
├── storage.rules              # Firebase Storage ルール
├── real-estate-ios/           # iOS アプリ（SwiftUI + SwiftData）
│   ├── RealEstateApp/         # アプリ本体ソースコード
│   ├── docs/                  # iOS アプリ設計ドキュメント
│   └── project.yml            # XcodeGen 設定
└── scraping-tool/             # Python スクレイピングパイプライン
    ├── scripts/               # シェルスクリプト（update_listings.sh 等）
    ├── data/                  # キャッシュ・マスターデータ
    ├── results/               # 出力（latest.json, report.md 等）
    ├── docs/                  # セットアップ・技術ドキュメント
    └── tests/                 # pytest テスト
```

---

## 2. システムアーキテクチャ

### 2.1 全体構成図

```
┌────────────────────────────────────────────────────────────────────┐
│                    GitHub Actions（CI/CD）                          │
│  main.py → enrichers → generate_report.py → send_push.py          │
│  → upload_scraping_log.py → slack_notify.py → git commit & push    │
└────────────────────┬───────────────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        ▼            ▼            ▼
┌──────────┐  ┌───────────┐  ┌──────────────┐
│ GitHub   │  │ Firebase  │  │ Slack        │
│ raw URL  │  │ (BaaS)    │  │ (Webhook)    │
│ JSON配信 │  │           │  │              │
└────┬─────┘  └─────┬─────┘  └──────────────┘
     │              │
     │    ┌─────────┴──────────────────────┐
     │    │ Firestore  : annotations,      │
     │    │              scraping_config,   │
     │    │              scraping_logs      │
     │    │ Auth       : Google Sign-In     │
     │    │ Storage    : 内見写真, 間取り図    │
     │    │ FCM        : プッシュ通知        │
     │    └─────────────────────────────────┘
     │              │
     ▼              ▼
┌────────────────────────────────────────────────────────────────────┐
│                  iOS アプリ（SwiftUI + SwiftData）                   │
│  ListingStore → SwiftData → UI                                     │
│  FirebaseSyncService ↔ Firestore                                   │
│  PhotoSyncService ↔ Firebase Storage                               │
│  CommuteTimeService → MKDirections                                 │
└────────────────────────────────────────────────────────────────────┘
```

### 2.2 技術スタック

| レイヤー | 技術 |
|---------|------|
| **iOS アプリ** | SwiftUI, SwiftData, MapKit, CoreLocation, PhotosUI, SafariServices |
| **認証** | Firebase Auth + Google Sign-In |
| **データ同期** | Firebase Firestore, Firebase Storage |
| **通知** | Firebase Cloud Messaging (FCM) + ローカル通知 |
| **スクレイピング** | Python 3.9, requests, BeautifulSoup4, lxml, Playwright |
| **データ配信** | GitHub raw URL（JSON） |
| **CI/CD** | GitHub Actions |
| **通知（開発者向け）** | Slack Webhook |
| **ビルド管理** | XcodeGen (project.yml) |

### 2.3 依存パッケージ

#### iOS（Swift Package Manager）

| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| Firebase | 12.9.0 | Auth, Firestore, Messaging, Storage |
| GoogleSignIn | 8.0.0 | Google サインイン |

#### Python（pip）

| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| requests | >=2.28.0,<3.0.0 | HTTP リクエスト |
| beautifulsoup4 | >=4.12.0,<5.0.0 | HTML パース |
| lxml | >=4.9.0,<6.0.0 | XML/HTML パーサー |
| pandas | >=2.0.0,<3.0.0 | データ分析 |
| pytest | >=7.0.0,<8.0.0 | テスト |
| PyJWT | >=2.8.0,<3.0.0 | JWT 生成（FCM用） |
| cryptography | >=41.0.0,<44.0.0 | 暗号処理 |
| Pillow | >=10.0.0,<12.0.0 | 画像処理 |
| firebase-admin | >=6.0.0,<7.0.0 | Firebase Admin SDK |
| playwright | >=1.40.0,<2.0.0 | ブラウザ自動操作 |

---

## 3. iOS アプリ仕様

### 3.1 基本情報

| 項目 | 値 |
|------|-----|
| **アプリ名** | 物件情報 |
| **Bundle ID** | com.hanawa.realestate.app |
| **対象 OS** | iOS 17.0+ |
| **対象デバイス** | iPhone のみ（iPad 非対応） |
| **デザイン方針** | HIG / OOUI / Liquid Glass（iOS 26）、Material フォールバック（iOS 17-25） |
| **カラーモード** | ライトモードのみ（`.preferredColorScheme(.light)`） |
| **ビルドツール** | XcodeGen（project.yml → .xcodeproj） |
| **Xcode** | 16.0+ |

### 3.2 認証

| 項目 | 仕様 |
|------|------|
| **方式** | Firebase Auth + Google Sign-In |
| **許可ユーザー** | メールアドレスホワイトリスト（`AuthService.allowedEmails`） |
| **フロー** | LoginView → GIDSignIn → Firebase Auth → ホワイトリストチェック → 許可/拒否 |
| **未許可時** | 自動サインアウト + エラー表示 |
| **URL ハンドリング** | `onOpenURL` → `AuthService.handle(url:)` で Google Sign-In コールバック処理 |

#### 許可メールアドレス
- `masaki.hanawa.417@gmail.com`
- `nogura.yuka.kf@gmail.com`

### 3.3 画面構成

#### ナビゲーション構造

```
App起動
├── 認証チェック中 → ProgressView（ローディング）
├── 未認証 → LoginView
│   └── Google サインインボタン
│   └── ウェーブアニメーション背景
└── 認証済み → ContentView
    ├── 初回ログイン → WalkthroughView（7ページ オンボーディング）
    └── TabView（5タブ）
        ├── [0] 物件 → PropertyListingTabView
        │   └── セグメントピッカー [中古 | 新築]
        │       ├── 中古 → ListingListView(propertyTypeFilter: "chuko")
        │       └── 新築 → ListingListView(propertyTypeFilter: "shinchiku")
        ├── [1] 地図 → MapTabView
        ├── [2] お気に入り → ListingListView(favoritesOnly: true)
        ├── [3] 成約 → TransactionTabView
        │   └── セグメントピッカー [一覧 | 地図]
        │       ├── 一覧 → TransactionListView（推定物件名あり、フィルタは都道府県別階層）
        │       └── 地図 → TransactionMapView（1物件=1ピン、タップで BuildingGroupDetailView）
        └── [4] 設定 → SettingsView
```

#### 3.3.1 ログイン画面（LoginView）

| 要素 | 詳細 |
|------|------|
| **背景** | 青系グラデーション + ウェーブアニメーション（`WaveShape`） |
| **アプリアイコン** | `AppIcon-Login` 画像 |
| **サインインボタン** | Google ブランドガイドライン準拠のボタン |
| **エラー表示** | ホワイトリスト外の場合にエラーメッセージ |

#### 3.3.2 物件一覧画面（ListingListView）

3つのモードで使用:
- **中古タブ**: `propertyTypeFilter: "chuko"`
- **新築タブ**: `propertyTypeFilter: "shinchiku"`
- **お気に入りタブ**: `favoritesOnly: true`

| 機能 | 詳細 |
|------|------|
| **ナビゲーションタイトル** | `.inline` 表示（ナビゲーションバーに固定、スクロールに追従しない） |
| **検索** | 物件名でインクリメンタル検索（`.searchable`） |
| **ソート** | 追加日（新しい順）、価格（安い順/高い順）、徒歩（近い順）、広さ（広い順）、偏差値の高い順（中古のみ）、儲かる確率の高い順（新築のみ） |
| **フィルタ** | FilterSheet（後述）で条件を指定 |
| **掲載終了フィルタ** | お気に入りタブ: すべて / 掲載中 / 掲載終了 |
| **比較モード** | ツールバーボタンで起動、2〜4件選択 → ComparisonView |
| **CSV エクスポート** | お気に入りタブで ShareLink による CSV 出力 |
| **Pull-to-refresh** | 手動データ更新 |
| **スワイプアクション** | いいね / 詳細表示 |

##### カード（行）の表示構成

各カードは最大5行で構成され、中古タブと新築タブで一部要素が異なる。

**共通要素（中古・新築共通）**

| 行 | 要素 | 詳細 |
|----|------|------|
| **1行目** | 物件名 | `.subheadline.weight(.semibold)`、1行制限。掲載終了物件はセカンダリカラー |
| | New バッジ | 前回同期時に存在しなかった新着物件に赤バッジ表示（物件名の右、カメラアイコンの左） |
| | 📷 写真数 | 写真がある場合のみ表示（カメラアイコン + 枚数） |
| | 💬 コメント数 | コメントがある場合のみ表示（吹き出しアイコン + 件数） |
| | ♥ いいねボタン | 赤ハート（いいね済み）/ グレーハート（未いいね） |
| **2行目** | 所有権/定借バッジ | 価格の左側に表示。所有権 → 青シールド、定借 → オレンジ時計アイコン |
| | 価格 | `priceDisplayCompact`。価格帯表示対応（例: 5,980万〜7,280万円） |
| | 複数戸売出バッジ | 同一マンションで複数戸売出中の場合に紫バッジ（例: 「3戸売出中」） |
| | 掲載終了バッジ | `isDelisted` = true の場合にオレンジバッジ（お気に入りタブのみ表示される） |
| **3行目** | 間取り | `layout`（例: 3LDK） |
| | 面積 | `areaDisplay`。面積帯対応（例: 65.12㎡〜82.50㎡） |
| **4行目** | 路線・駅名 | `displayStationLine`（例: 東京メトロ丸ノ内線 新宿御苑前駅 徒歩5分） |
| **5行目** | ハザードバッジ | リスクがある場合のみ。洪水・土砂・液状化等を色付きバッジで表示。東京都地域危険度（建物倒壊・火災・総合）はそれぞれ独立ラベルで表示（例: "倒壊3"、"火災4"、"総合3"）。各ラベルに専用アイコン付き |
| | 通勤時間バッジ | Playground / M3Career への通勤時間（ロゴアイコン + 分数） |

> **一覧バッジ高さ統一ルール**: 一覧行内の全バッジ（New / 所有権・定借 / 騰落率 / 儲かる確率 / 偏差値 / 複数戸売出 / 掲載終了 / ハザード / 通勤時間）は、`.padding(.vertical, 2)` + `.padding(.horizontal, 5)` + `cornerRadius: 4` で統一し、高さを揃える。

**中古タブ固有の要素**

| 行 | 要素 | 詳細 |
|----|------|------|
| **2行目** | 騰落率バッジ | `ssAppreciationRate` — 値上がり: 緑↑、値下がり: 赤↓（例: ↑12%） |
| | 偏差値バッジ | `averageDeviation` — 平均偏差値を色分け表示（60以上=青、55以上=シアン、50以上=ティール、45以上=オレンジ、未満=グレー） |
| | 価格カラー | 青系（`Color.accentColor`） |
| **3行目** | 築年 | `builtAgeDisplay`（例: 築12年） |
| | 階数 | `floorDisplay` — 所在階/階建て（例: 5階/12階建）。データなしの場合は非表示 |
| | 総戸数 | `totalUnitsDisplay`（例: 120戸） |

**新築タブ固有の要素**

| 行 | 要素 | 詳細 |
|----|------|------|
| **2行目** | 儲かる確率バッジ | `ssProfitPct` — 青系バッジ（例: 儲かる 78%） |
| | 価格カラー | 緑系（`DesignSystem.shinchikuPriceColor`） |
| **3行目** | 入居時期 | `deliveryDateDisplay`（例: 2026年3月） |
| | 階建て | `floorTotalDisplay` — 「—」でない場合のみ表示（例: 15階建） |
| | 総戸数 | `totalUnitsDisplay`（例: 250戸） |

#### 3.3.3 フィルタシート（ListingFilterSheet）

| フィルタ項目 | 入力形式 | 詳細 |
|-------------|---------|------|
| **価格** | レンジスライダー | 最小〜最大（万円）、価格未定含むチェック |
| **間取り** | チップ複数選択 | 1K, 1LDK, 2LDK, 3LDK, ... |
| **駅名** | プルダウン（路線別）+ チェックボックス | DisclosureGroup で路線を展開し、駅名をチェックボックスで複数選択。路線内一括選択/解除・全選択解除ボタン付き |
| **駅徒歩** | スライダー | ○分以内 |
| **専有面積** | スライダー | ○㎡以上 |
| **区** | チップ複数選択 | 東京23区 |
| **権利形態** | チェックボックス | 所有権 / 定期借地 |
| **物件種別** | セグメント | すべて / 中古のみ / 新築のみ |

フィルタ状態は `FilterStore`（`@Observable`）でタブごとに独立管理（OOUI: 中古/新築/お気に入りで干渉しない）。

#### 3.3.4 物件詳細画面（ListingDetailView）

Sheet として表示。以下のセクションで構成:

**共通セクション（中古・新築共通）**

| # | セクション | 内容 |
|---|-----------|------|
| ① | **掲載終了バナー** | `isDelisted` = true のとき表示 |
| ② | **物件名** | タイトル表示 |
| ③ | **住所** | 住所テキスト + Google Maps リンク |
| ④ | **コメント** | 入力フィールド + コメント一覧（編集・削除可） |
| ⑤ | **内見写真** | PhotoSectionView（撮影・ライブラリ選択・フルスクリーン表示） |
| ⑤-b | **間取り図** | `hasFloorPlanImages` の場合のみ。SUUMO/HOME'S の物件詳細ページから取得した間取り図画像を Firebase Storage 経由で表示（掲載終了後も永続表示可能）。タップでピンチズーム対応のフルスクリーン表示。複数枚の場合は横スクロール |
| ⑥ | **物件基本情報** | 下記の共通項目 + 中古/新築固有項目を表示 |
| ⑦ | **月額支払いシミュレーション** | `priceMan > 0` の場合（中古・新築共通）。下記の計算ロジックで動的に算出。タップでフォーム展開し金利・返済期間・頭金を変更可能 |
| ⑧ | **通勤時間** | Playground / M3Career への通勤時間（MKDirections）+ Google Maps リンク。座標ありかつ未取得の場合は計算ボタン表示 |
| ⑨ | **住まいサーフィン評価** | 常に表示。`hasSumaiSurfinData` の場合は評価データ（沖式時価・値上がり率・レーダーチャート等）+ 販売価格割安判定（`hasPriceJudgments` の場合、折りたたみ式サブセクション）を表示。未取得の場合はステータスに応じた案内メッセージを表示 |
| ⑨-b | **周辺相場（住まいサーフィン）** | `hasSurroundingProperties` の場合のみ。周辺中古マンションの相場一覧（折りたたみ） |
| ⑩ | **値上がり・含み益シミュレーション** | `hasSimulationData` の場合のみ。5年/10年の楽観・標準・悲観の3シナリオ + 含み益チャート |
| ⑪ | **成約相場との比較** | `hasMarketData` の場合のみ。MarketDataSectionView で成約データと比較表示 |
| ⑫ | **エリア人口動態** | `hasPopulationData` の場合のみ。PopulationSectionView で人口推移を表示 |
| ⑬ | **ハザード情報** | `hasHazardData` の場合のみ。洪水、内水、土砂、高潮、津波、液状化 の各リスクレベル |
| ⑭ | **外部リンク** | SUUMO / HOME'S 詳細ページ、住まいサーフィンページ。掲載終了時は掲載終了メッセージに置換 |

##### 月額支払いシミュレーション 計算ロジック

**計算式（元利均等返済）**

```
M = P × r × (1+r)^n / ((1+r)^n - 1)

M = 月額ローン返済額（万円）
P = 借入元本（万円）= 物件価格 - 頭金
r = 月利 = 年利(%) / 100 / 12
n = 返済回数（月）= 返済年数 × 12

月額合計 = M × 10,000 + 管理費(円) + 修繕積立金(円)
返済総額 = M × n
```

**デフォルトパラメータ（iOS / Python 共通）**

| パラメータ | デフォルト値 | 備考 |
|-----------|------------|------|
| 年利 | 0.8% | 変動金利想定 |
| 返済期間 | 50年 | |
| 頭金 | 0万円 | |
| 管理費 | スクレイピング実額 | SUUMO/HOME'S から取得。未取得時は 0 |
| 修繕積立金 | スクレイピング実額 | 同上 |

**動的フォーム（MonthlyPaymentSimulationView）**

| パラメータ | UI | 範囲 | 刻み |
|-----------|-----|------|------|
| 金利 (%) | Stepper（カード型） | 0.1 ~ 5.0 | 0.01 |
| 返済期間 (年) | Menu（カード型プルダウン、chevron.up.chevron.down アイコン付き） | 20, 30, 35, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50 | — |
| 頭金 (万円) | Slider（カード型） | 0 ~ 物件価格 | 物件価格/100（最小10万円） |

- 各フォーム項目は `systemGray6` 背景 + `systemGray4` ボーダーのカード型レイアウトで統一
- 初期状態: 折りたたみ（デフォルトパラメータで計算した結果のみ表示）
- タップで展開: フォーム表示 + 返済総額（参考）を追加表示
- パラメータ変更時: リアルタイムに月額合計・内訳・返済総額を再計算
- 「デフォルトに戻す」ボタン: デフォルト値と異なる場合のみ表示

**実装ファイル**

| ファイル | 役割 |
|---------|------|
| `LoanCalculator.swift` | 計算ロジック。`monthlyPayment(principal:rate:years:)` / `totalRepayment(principal:rate:years:)`。`simulate(listing:)` は listing URL + 主要パラメータでセッション内キャッシュし、body 再評価時の再計算を回避 |
| `MonthlyPaymentSimulationView.swift` | 動的フォーム付き UI |
| `ListingDetailView.swift` | 物件詳細のメイン画面。body を軽量化するため、各セクションを @ViewBuilder の private var に切り出している（delistedBanner, addressSection, commentSection, floorPlanSection, propertyInfoSection, commuteSection, hazardSection, sumaiSurfinSection, surroundingPropertiesSection, priceJudgmentsSection, externalLinksSection 等）。`FloorPlanFullScreenView` は間取り図のピンチズーム対応フルスクリーン表示 |
| `loan_calc.py` (Python) | Slack 通知・レポート用の月額計算（同一パラメータ） |

**物件基本情報の表示項目**

| 項目 | 中古 | 新築 |
|------|:----:|:----:|
| 最寄駅（複数対応） | ○ | ○ |
| 価格 | ○ | ○ |
| 売出戸数（複数戸売出時のみ） | ○ | ○ |
| 間取り / 面積 | ○ | ○ |
| 築年 | ○ | — |
| 入居時期 | — | ○ |
| 所在階 / 階建 | ○（所在階 / 階建） | ○（階建のみ） |
| 総戸数 | ○ | ○ |
| 権利形態 | ○ | ○ |
| 種別 | 中古マンション | 新築マンション |

**中古タブ固有のセクション**

| セクション | 内容 |
|-----------|------|
| **住まいサーフィン評価（中古）** | 沖式中古時価（実面積/70㎡換算）、中古値上がり率（未取得時は「—」表示）、割安判定バッジ、レーダーチャート（6軸偏差値）、駅・区ランキング、販売価格割安判定（`hasPriceJudgments` の場合。後述） |
| **周辺相場** | `hasSurroundingProperties` の場合のみ。周辺の中古マンション相場を表示（後述） |

##### 周辺相場セクション

**データ取得**

住まいサーフィンの中古・新築物件ページから「周辺の中古マンション相場」テーブルを HTML パースで取得する（`sumai_surfin_enricher.py` `_extract_surrounding_properties()`）。

| 取得フィールド | 型 | 説明 |
|------------|------|------|
| `name` | String | 周辺マンション名 |
| `url` | String? | 住まいサーフィン物件 URL（リンクが存在する場合） |
| `appreciation_rate` | Double? | 中古値上がり率（%）。**取得にはログインが必須**（取得前に必ずログイン済みセッションを使用すること）。非ログイン時は `XX%` でマスクされ数値を取得できない。マスク値検出時は警告を出力する。取得できなかった場合も `null` としてキーを必ず含め、iOS 側で「未取得」を明示表示する |
| `oki_price_70m2` | Int? | 沖式中古時価 70㎡換算（万円）。500万円未満は除外 |

**格納フィールド:** `ss_surrounding_properties`（JSON 文字列）

**表示条件:** `hasSurroundingProperties` = `ss_surrounding_properties != nil && parsedSurroundingProperties が空でない`

**UI 仕様**

- 折りたたみ式セクション（初期: 折りたたみ）
- ヘッダー: 「周辺の中古マンション相場」+ 件数
- 展開時の各行:
  - 物件名（URL がある場合はタップで Safari 遷移）
  - 中古値上がり率（正=緑、負=赤、未取得時は「—」をグレー表示）
  - 沖式中古時価 70㎡換算（万円）

##### 販売価格割安判定セクション（住まいサーフィン評価セクション内に表示）

**データ取得**

住まいサーフィンの中古物件ページで「販売価格が割安か判定する」ボタンをブラウザ自動化（Playwright）でクリックし、判定結果を取得する（`sumai_surfin_browser.py` `extract_chuko_price_judgments()`）。中古物件のみ対象。住まいサーフィン評価セクション（`sumaiSurfinSection`）内の末尾に、Divider を挟んで折りたたみ式サブセクションとして表示する。

取得フロー:
1. `#js-usedprice-judge-exec` ボタンをクリック
2. `#js-usedprice-judge-result-text` から判定テキストを取得
3. 複数住戸の場合: `.u-sellPrice_roomNumber.-navi` を順にクリックし各住戸の判定を収集
4. 各住戸の階数・価格・面積・間取りを `_extract_current_slide_info()` で抽出
5. フォールバック: API `/common/data/judge_usedprice.php` 直接呼び出し、正規表現抽出

| 取得フィールド | 型 | 説明 |
|------------|------|------|
| `unit` | String? | 住戸情報（例: `"6階/23階"`） |
| `price_man` | Int? | 販売価格（万円） |
| `m2_price` | Int? | m²単価（万円） |
| `layout` | String? | 間取り（例: `"2SLDK"`） |
| `area_m2` | Double? | 面積（㎡） |
| `direction` | String? | 向き |
| `oki_price_man` | Int? | 沖式中古時価（万円） |
| `difference_man` | Int? | 差額（万円、マイナス=割安） |
| `judgment` | String? | 判定ラベル（`割安` / `やや割安` / `適正` / `やや割高` / `割高`） |

**格納フィールド:** `ss_price_judgments`（JSON 文字列）、`ss_value_judgment`（代表判定文字列）

**表示条件:** `hasPriceJudgments` = `ss_price_judgments != nil && parsedPriceJudgments が空でない`

**代表判定の決定ロジック（`computedPriceJudgment`）**

判定ラベル（割安・やや割安・適正価格・やや割高・割高）は住まいサーフィンが提供するデータをそのまま使用する。独自の閾値による計算は行わない。

優先順位:
1. `ssValueJudgment` — ブラウザ自動化で取得した代表判定（「販売価格が割安か判定する」ボタン押下結果）
2. `ssPriceJudgments` — 住戸ごとの判定から掲載価格（`priceMan`）に最も近い住戸の `judgment` を採用（1住戸なら即採用、掲載価格なしの場合は先頭住戸）
3. データなし → `nil`（判定バッジを非表示）

**UI 仕様**

- 住まいサーフィン評価セクション（`sumaiSurfinSection`）内の末尾に Divider を挟んで表示
- 折りたたみ式サブセクション（初期: 折りたたみ）
- ヘッダー: 「販売価格 割安判定」+ 割安住戸サマリ（例: `2/5戸割安`、割安なしの場合は `5戸`）
- 展開時の各行:
  - 1行目: 住戸情報（階数）、間取り、面積 + 判定バッジ
  - 2行目: 販売価格、沖式時価、差額（マイナス=緑、プラス=赤）
- 判定バッジのカラーマッピング:
  - `割安` / `やや割安` → 緑（`positiveColor`）
  - `割高` / `やや割高` → 赤（`negativeColor`）
  - `適正` / `適正価格` → オレンジ
  - その他 → グレー

**新築タブ固有のセクション**

| セクション | 内容 |
|-----------|------|
| **住まいサーフィン評価（新築）** | 沖式儲かる確率、m²割安額、割安判定バッジ、駅・区ランキング |
| **10年後予測詳細** | `hasForecastDetail` の場合のみ。沖式新築時価（70㎡）、新築時m²単価、10年後予測m²、予測変動率 |

#### 3.3.5 地図画面（MapTabView）

| 機能 | 詳細 |
|------|------|
| **地図表示** | MKMapView で全物件をピン表示 |
| **ピン色分け** | 中古（青●）/ 新築（緑●）/ いいね済み（赤♥） |
| **ピンタップ** | ポップアップ → 物件概要 + いいねボタン → タップで詳細遷移 |
| **フィルタ** | 一覧と共通の FilterStore |
| **現在地ボタン** | 左下ボタンで CLLocationManager → 現在地に移動 |
| **凡例** | 中古 / 新築 / いいね のアイコン凡例 |

##### ハザードマップオーバーレイ

Sheet で表示/非表示を切替。以下のレイヤーを国土地理院 WMS タイルで重畳:

| カテゴリ | レイヤー |
|---------|---------|
| **基本** | 洪水浸水想定、内水浸水想定、土砂災害警戒区域、高潮浸水想定、津波浸水想定、液状化（地形分類）※1 |
| **洪水詳細** | 浸水継続時間、家屋倒壊（氾濫流）、家屋倒壊（河岸侵食） |
| **地盤** | 揺れやすさ（地形分類）※1 |

> ※1 液状化リスク・揺れやすさの GSI オリジナルタイル（`08_liquid`・`13_jibanshindou`）は非公開(404)のため、代替として国土地理院 治水地形分類図（`lcmfc2`）を使用。地形種別（旧河道・後背湿地等）からリスクを間接的に判読する。

**タイルズーム制限（`maxNativeZoom`）**: GSI タイルのデータ公開ズームレベルはレイヤーにより異なる。`MKTileOverlay.maximumZ` をレイヤーごとの `maxNativeZoom` に設定し、超過ズームでは最大ズームタイルを拡大表示する。

| レイヤー | maxNativeZoom | 備考 |
|---------|:---:|------|
| 洪水・土砂・高潮・浸水継続・液状化・揺れやすさ | 17 | フル対応 |
| 家屋倒壊（氾濫流・河岸侵食） | 13 | z≥14 は拡大表示 |
| 津波浸水想定 | 11 | z≥12 は拡大表示 |
| 内水浸水想定 | 9 | 東京都は z=9 まで（都府県によりデータ範囲が異なる） |

##### 東京都地域危険度オーバーレイ

| レイヤー | データソース |
|---------|------------|
| **建物倒壊危険度** | GeoJSON（GitHub raw） → MKPolygon ランク1-5色分け |
| **火災危険度** | 同上 |
| **総合危険度** | 同上 |

#### 3.3.6 設定画面（SettingsView）

| セクション | 項目 |
|-----------|------|
| **通知** | 通知許可設定へのリンク |
| **データ** | フルリフレッシュ、カスタム JSON URL（中古・新築） |
| **スクレイピング** | 条件設定（ScrapingConfigView）、実行ログ（ScrapingLogView） |
| **アカウント** | ユーザー情報表示、サインアウト |
| **ウォークスルー** | オンボーディング再表示 |

#### 3.3.7 物件比較画面（ComparisonView）

- 2〜4件を横並びで比較
- 横スクロールテーブル形式
- 比較項目: 価格、間取り、面積、築年、徒歩、階数、総戸数、権利形態、住まいサーフィン評価

#### 3.3.8 内見写真（PhotoSectionView）

| 機能 | 詳細 |
|------|------|
| **撮影** | CameraCaptureView（UIImagePickerController） |
| **ライブラリ選択** | PhotosPicker（PhotosUI） |
| **サムネイル表示** | PhotoThumbnailView（NSCache でキャッシュ） |
| **フルスクリーン** | PhotoFullscreenView |
| **ローカル保存** | PhotoStorageService → アプリ Documents ディレクトリ |
| **クラウド同期** | PhotoSyncService → Firebase Storage |
| **サイズ制限** | 最大 10MB / 画像ファイルのみ |

#### 3.3.9 オンボーディング（WalkthroughView）

- 7ページ構成
- ページごとにグラデーション背景
- 初回ログイン時に自動表示
- 設定画面から再表示可能

### 3.4 サービス層

#### 3.4.1 ListingStore（物件データ取得・同期）

| 項目 | 詳細 |
|------|------|
| **データソース** | GitHub raw URL の JSON（中古: `latest.json` / 新築: `latest_shinchiku.json`） |
| **デフォルト URL** | `https://raw.githubusercontent.com/masakihnw/real-estate/main/scraping-tool/results/latest.json` |
| **カスタム URL** | 設定画面から変更可能（UserDefaults に保存） |
| **同期方式** | フル置き換え。`identityKey` でマッチして更新/挿入/削除 |
| **ETag キャッシュ** | レスポンスの ETag を保存し、`If-None-Match` で 304 判定 |
| **並列取得** | 中古・新築を `async let` で並列リクエスト |
| **JSON デコード** | `Task.detached(priority: .userInitiated)` でバックグラウンド実行 |
| **新規検出** | 既存の `identityKey` に存在しない物件 → `isNew = true` + ローカル通知。同期ごとに既存物件の `isNew` をリセットし、新規挿入物件のみ `isNew = true` に設定。304 Not Modified 時も `isNew` をリセットし、New バッジが残り続けないようにする |
| **自動更新** | フォアグラウンド復帰時に15分経過していれば自動 refresh |
| **lastError** | メインの JSON 取得・同期エラー（致命的）。UI に表示 |
| **syncWarning** | 非致命的な同期警告（Firebase いいね・メモ、通勤時間計算など）。`pullAnnotations` / `calculateForAllListings` 失敗時に設定。UI で任意表示可能 |
| **fetchCount エラー** | `fetchCount` 失敗時は do/catch でログ出力し、デフォルト 0 でフルフェッチを強制 |

#### 3.4.2 FirebaseSyncService（Firestore 同期）

| 操作 | 詳細 |
|------|------|
| **いいね同期** | `pushLikeState(for:)` → `annotations/{docId}` に `isLiked` を書き込み |
| **コメント追加** | `addComment` → `annotations/{docId}.comments` 配列に追加 |
| **コメント編集** | `editComment` → 該当コメントのテキストを更新 |
| **コメント削除** | `deleteComment` → 該当コメントを配列から除去 |
| **プル同期** | `pullAnnotations(modelContext:onError:)` → 全 annotations を取得しローカル SwiftData に反映。`onError` で失敗時にコールバック（ListingStore の syncWarning 設定用） |
| **ドキュメント ID** | SHA256(`identityKey`) の先頭16文字 |

#### 3.4.3 CommuteTimeService（通勤時間計算）

通勤時間データは **2段階** で取得される:

1. **パイプライン側（即時表示用）**: `commute_enricher.py` が駅名ベースのドアtoドア概算を `commute_info` として JSON に付与。アプリ起動時に即座に表示可能
2. **iOS 側（高精度更新）**: `CommuteTimeService` が MKDirections（Apple Maps 公共交通機関）でより正確な経路を取得し、パイプラインデータを上書き

| 項目 | 詳細 |
|------|------|
| **パイプライン初期データ** | `commute_enricher.py` が `station_line` + `walk_min` から駅ベースの概算を付与（`commute_info` フィールド）。`Listing.from(dto:)` で `commuteInfoJSON` に取り込み |
| **iOS 計算方式** | MKDirections（公共交通機関モード、`requestsAlternateRoutes = true`） |
| **目的地** | Playground株式会社（千代田区一番町4-6）/ エムスリーキャリア（港区虎ノ門4-1-28） |
| **キャッシュ** | `Listing.commuteInfoJSON` に JSON 文字列で保存 |
| **再計算条件** | 未計算 or フォールバック概算（`経路情報取得不可`）or 7日以上経過 |
| **リトライ戦略** | 1回目: departureDate（次の平日8:00）→ 2回目: 日時指定なし → 3回目: arrivalDate（次の平日9:00）→ フォールバック概算。各リトライ間に2秒待機 |
| **シミュレータ対応** | `#if targetEnvironment(simulator)` でリトライをスキップし即座にフォールバック概算を使用（MKDirections Transit はシミュレータ非対応） |
| **ダウングレード防止** | 既存データがパイプライン/MKDirections の正規経路で、新結果がフォールバック概算の場合は上書きしない |
| **同期時の更新ロジック** | `update(existing:from:)` で既存データが nil またはフォールバック概算の場合のみパイプラインデータを取り込む。MKDirections の正規経路データは保持 |
| **座標バージョン管理** | 目的地座標変更時に UserDefaults でバージョン管理、全件再計算 |
| **Google Maps 連携** | ディープリンクで Google Maps アプリ（またはブラウザ）を起動 |
| **onError コールバック** | `calculateForAllListings(modelContext:onError:)` の `onError` で失敗時にコールバック（ListingStore の syncWarning 設定用） |

#### 3.4.4 通知サービス

| サービス | 種類 | 詳細 |
|---------|------|------|
| **NotificationScheduleService** | ローカル通知 | 新規物件追加時に蓄積 → スケジュール時刻にまとめて配信。新コメント・新写真も通知。 |
| **PushNotificationService** | FCM リモート通知 | トピック `new_listings` を購読。GitHub Actions からスクレイピング後に送信。 |
| **BackgroundRefreshManager** | バックグラウンド更新 | `BGAppRefreshTask` で定期的に JSON 取得 → 新着検出 → ローカル通知 |

#### 3.4.5 その他のサービス

| サービス | 役割 |
|---------|------|
| **NetworkMonitor** | NWPathMonitor でネットワーク接続状態を監視。オフラインバナー表示に使用。 |
| **PhotoStorageService** | ローカルファイルシステムへの写真保存/読込/削除。NSCache でメモリキャッシュ。 |
| **PhotoSyncService** | Firebase Storage への写真アップロード/ダウンロード/削除。 |
| **ScrapingConfigService** | Firestore の `scraping_config/default` からスクレイピング条件を取得/保存。 |
| **ScrapingLogService** | Firestore の `scraping_logs/latest` からパイプラインログを取得。 |
| **SaveErrorHandler** | SwiftData 保存エラーのハンドリング。エラーダイアログ表示。 |
| **ModelContainer 初期化失敗** | ディスク・インメモリ両方失敗時は `fatalError` でクラッシュ。メッセージにエラー内容・再インストール・ストレージ確認を案内。 |

### 3.5 ローンシミュレーション

#### 3.5.1 アプリ独自の計算条件

| パラメータ | 値 |
|-----------|-----|
| **想定価格** | 9,500万円（新築デフォルト） |
| **金利** | 0.8%（変動） |
| **返済期間** | 50年 |
| **頭金** | 0万円 |

#### 3.5.2 住まいサーフィンとの違い

| 項目 | アプリ | 住まいサーフィン |
|------|--------|----------------|
| 想定価格 | 9,500万円 | 6,000万円 |
| 金利 | 0.8% | 0.79% |
| 返済期間 | 50年 | 35年 |

住まいサーフィンからは**変動率（%）のみ**を取り込み、予測価格・ローン残高・含み益はアプリ独自パラメータで再計算。

#### 3.5.3 シミュレーション出力

| 出力 | 内容 |
|------|------|
| **月額返済額** | 元利均等返済の月額 |
| **ローン残高** | 5年後 / 10年後の残債 |
| **予測価格** | 楽観 / 標準 / 悲観 の3シナリオ × 5年後・10年後 |
| **含み益** | 予測価格 − ローン残高（シナリオ別） |
| **シナリオ幅** | ±10ポイント（`scenarioSpreadPP`） |

### 3.6 デザインシステム

#### 3.6.1 DesignSystem.swift

共通のデザイントークンを一元管理:

| トークン | 用途 |
|---------|------|
| **余白** | `listRowVerticalPadding`, `listRowHorizontalPadding` |
| **角丸** | `cornerRadius` |
| **フォントスタイル** | `ListingObjectStyle`（title / subtitle / caption / detailValue / detailLabel） |
| **色** | `shinchikuPriceColor`, `positiveColor`, `negativeColor`, `commutePGColor`, `commuteM3Color`, `cardBackground` |
| **ガラス背景** | `listingGlassBackground()`, `tintedGlassBackground()` |

#### 3.6.2 Liquid Glass 対応

| iOS バージョン | 実装 |
|---------------|------|
| **iOS 26+** | `.glassEffect(in: .rect(cornerRadius:))` で Liquid Glass 適用 |
| **iOS 17-25** | `RoundedRectangle` + `.ultraThinMaterial` でガラス風フォールバック |
| **タブバー** | iOS 26 ではシステムが自動で Liquid Glass を適用 |

#### 3.6.3 アセットカタログ

| アセット | 用途 |
|---------|------|
| `AppIcon` | アプリアイコン |
| `AppIcon-Login` | ログイン画面用アイコン |
| `AccentColor` | アクセントカラー |
| `tab-chuko`, `tab-shinchiku`, `tab-map`, `tab-favorites`, `tab-settings` | タブアイコン |
| `icon-hazard` | ハザードアイコン |
| `logo-m3career`, `logo-playground` | 通勤バッジロゴ |

#### 3.6.4 SwiftUI ForEach の識別子

`ForEach` では `id: \.offset` を使わず、データモデル由来の安定した識別子を指定する。`\.offset` は SwiftUI の diff で誤動作を引き起こし得るため禁止。

| データ | 推奨 id |
|--------|---------|
| ハザードラベル `(icon, label, severity)` | `\.element.label` |
| `QuarterlyPrice` | `\.element.quarter` |
| `YearValue` (人口推移) | `\.element.year` |
| 凡例 `(color, label)` | `\.element.label` |
| 固定長インデックス（レーダー軸・通知時刻など） | `ForEach(0..<count, id: \.self)` で index アクセス |
| `SameBuildingTransaction`（区別が難しい場合） | `ForEach(0..<min(count, 5), id: \.self)` で index アクセス |

---

## 4. 画面別機能一覧

全画面で利用可能な操作・インタラクションを網羅的にまとめる。

---

### 4.1 ログイン画面（LoginView）

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | Google サインイン | ボタンタップ | Google アカウント選択 → Firebase Auth → ホワイトリストチェック |
| 2 | エラー表示 | 自動 | 許可されていないメールの場合にエラーメッセージを表示 |
| 3 | ローディング表示 | 自動 | サインイン処理中に ProgressView を表示 |
| 4 | 不正ログイン防止 | 自動 | 画面表示時にログイン済みだがホワイトリスト外の場合、自動サインアウト |

---

### 4.2 オンボーディング（WalkthroughView）

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | ページ閲覧 | 左右スワイプ | 7ページのガイドをスワイプで移動 |
| 2 | 次へ進む | 「次へ」ボタン | 次のページへ遷移 |
| 3 | 前に戻る | 「戻る」ボタン | 前のページへ遷移（2ページ目以降で表示） |
| 4 | スキップ | 「スキップ」ボタン | 最終ページ以外で表示。即座に完了 |
| 5 | 開始 | 「はじめる」ボタン | 最終ページで表示。オンボーディング完了 |
| 6 | ページインジケーター | 自動 | 現在のページ位置をカプセルで表示 |
| 7 | アニメーション | 自動 | ページ切替時にコンテンツアニメーション |

---

### 4.3 中古タブ / 新築タブ（ListingListView）

中古タブ（`propertyTypeFilter: "chuko"`）と新築タブ（`propertyTypeFilter: "shinchiku"`）は同一の View を使用。

#### 検索・表示

> **パフォーマンス**: フィルタ＋ソート結果は `onChange(of:)` で検知した場合のみ再計算し、`@State cachedFiltered` にキャッシュ。検索・ソート・フィルタ・listings 変更時に更新。MapTabView も同様に `filteredListings` をキャッシュ。

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | 物件名検索 | テキスト入力 | インクリメンタル検索。物件名でフィルタ。 |
| 2 | 検索クリア | クリアボタン | 検索テキストを空にする |
| 3 | 一覧表示 | 自動 | 物件をリスト形式で表示（物件名、価格、間取り、面積、徒歩、バッジ） |
| 4 | 空状態 | 自動 | データなし時に「データを取得」ボタン付きの案内を表示 |
| 5 | フィルタ空状態 | 自動 | フィルタ条件に合う物件がない時に「フィルタをリセット」ボタンを表示 |

#### ソート

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 6 | 追加日（新しい順） | ソートメニュー選択 | デフォルト。`addedAt` 降順 |
| 7 | 価格（安い順） | ソートメニュー選択 | `priceMan` 昇順 |
| 8 | 価格（高い順） | ソートメニュー選択 | `priceMan` 降順 |
| 9 | 徒歩（近い順） | ソートメニュー選択 | `walkMin` 昇順 |
| 10 | 広さ（広い順） | ソートメニュー選択 | `areaM2` 降順 |

#### フィルタ

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 11 | フィルタシート表示 | ツールバーボタン | フルスクリーンでフィルタ画面を表示 |
| 12 | フィルタリセット | リセットボタン | 全条件を初期値に戻す |

#### 物件操作

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 13 | 物件詳細表示 | 行タップ | Sheet で物件詳細画面を表示 |
| 14 | いいね | 右スワイプ | いいね ON/OFF 切替 → Firestore 同期 |
| 15 | 詳細を開く | 左スワイプ | 詳細画面を Sheet で表示 |

#### 比較機能

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 16 | 比較モード開始 | ツールバーボタン | チェックボックス付きモードに切替 |
| 17 | 物件選択 | チェックボックスタップ | 最大4件まで選択（5件目は選択不可） |
| 18 | 比較画面表示 | 「比較する」ボタン | 2件以上選択時に有効。ComparisonView を Sheet で表示 |
| 19 | 比較モード終了 | 「キャンセル」ボタン | 選択をクリアして通常モードに戻る |

#### データ更新

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 20 | 手動更新 | Pull-to-refresh | JSON URL から最新データを取得して SwiftData を更新 |
| 21 | 更新中表示 | 自動 | 更新中にバナーで表示 |
| 22 | エラー表示 | エラーボタンタップ | データ取得エラーの詳細をアラートで表示 |

---

### 4.4 お気に入りタブ（ListingListView favoritesOnly）

中古タブ/新築タブの全機能に加えて、以下の追加機能:

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | 掲載終了フィルタ | チップタップ | 「すべて」「掲載中」「掲載終了」で切替 |
| 2 | CSV エクスポート | ツールバー ShareLink | お気に入り物件を CSV 形式で共有 |
| 3 | すべて表示に戻す | 「すべて表示」ボタン | 掲載終了フィルタを「すべて」に戻す |

---

### 4.5 フィルタシート（ListingFilterSheet）

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | 価格下限設定 | スライダー | 最低価格を設定（万円） |
| 2 | 価格上限設定 | スライダー | 最高価格を設定（万円） |
| 3 | 価格未定物件を含む | トグル | 価格未定の新築物件を含めるかどうか |
| 4 | 間取り選択 | チップ複数選択 | 1K, 1LDK, 2LDK, 3LDK 等をタップで ON/OFF |
| 5 | 駅徒歩上限 | スライダー | ○分以内を設定 |
| 6 | 専有面積下限 | スライダー | ○㎡以上を設定 |
| 7 | 区選択 | グリッドタップ | 東京23区をタップで ON/OFF |
| 8 | 権利形態選択 | チップタップ | 所有権 / 定期借地を選択 |
| 9 | 物件種別選択 | チップタップ | すべて / 中古のみ / 新築のみ |
| 10 | フィルタ適用 | 適用ボタン | 現在のフィルタ条件で一覧をフィルタ |
| 11 | フィルタリセット | リセットボタン | 全条件を初期値に戻す |
| 12 | キャンセル | 閉じるボタン | フィルタ変更を破棄して閉じる |
| 13 | アコーディオン展開 | セクションヘッダータップ | 各フィルタセクションの展開/折りたたみ |

---

### 4.6 物件詳細画面（ListingDetailView）

#### ヘッダー操作

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | 閉じる | ツールバーボタン | Sheet を閉じる |
| 2 | 共有 | ツールバー ShareLink | 物件 URL を共有 |
| 3 | いいね | ツールバーハートボタン | いいね ON/OFF → Firestore 同期 |
| 4 | キーボード非表示 | 画面タップ | コメント入力中のキーボードを閉じる |

#### 掲載状態

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 5 | 掲載終了バナー | 自動 | `isDelisted` 時に警告バナーを表示 |

#### 住所・地図

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 6 | Google Maps で開く | 住所タップ | Google Maps アプリ（またはブラウザ）で住所を検索 |

#### コメント機能

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 7 | コメント投稿 | テキスト入力 + 送信ボタン | コメントを追加 → Firestore 同期 |
| 8 | コメント編集 | 編集ボタン | 既存コメントのテキストを編集モードに → 更新 |
| 9 | コメント削除 | 削除ボタン | 確認ダイアログ表示 → 削除 → Firestore 同期 |
| 10 | 編集キャンセル | キャンセルボタン | 編集モードを解除してテキストを元に戻す |

#### 内見写真

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 11 | 写真撮影 | カメラボタン | カメラを起動して撮影 → ローカル保存 + Firebase Storage アップロード |
| 12 | ライブラリから選択 | フォトライブラリボタン | PhotosPicker で画像選択 → 保存 + アップロード |
| 13 | サムネイル表示 | 横スクロール | 保存済み写真のサムネイルを横スクロールで一覧 |
| 14 | フルスクリーン表示 | サムネイルタップ | 写真をフルスクリーンで表示（スワイプで切替） |
| 15 | 写真削除 | サムネイル右上の×ボタン | 確認ダイアログ → ローカル + クラウドから削除 |
| 16 | アップロード状態表示 | 自動 | アップロード中は ProgressView、完了後はクラウドアイコン表示 |
| 17 | 投稿者名表示 | 自動 | 他ユーザーの写真には投稿者名を表示 |

#### 間取り図

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 17-b | 間取り図表示 | 閲覧 | `hasFloorPlanImages` の場合のみ。Firebase Storage から間取り図画像を表示（1枚=フル幅、複数枚=横スクロール）。画像は掲載終了後も永続的に表示可能 |
| 17-c | フルスクリーン表示 | 画像タップ | 間取り図をフルスクリーンで表示（ピンチズーム・ダブルタップズーム対応） |

#### 物件基本情報

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 18 | 価格表示 | 閲覧 | 万円表示。新築は価格帯（○万〜○万） |
| 19 | 間取り表示 | 閲覧 | 例: "3LDK"、新築は範囲 |
| 20 | 面積表示 | 閲覧 | ○㎡。新築は範囲（○〜○㎡） |
| 21 | 築年表示 | 閲覧 | 築年月 + 築○年の計算表示 |
| 22 | 階数表示 | 閲覧 | ○階 / ○階建て |
| 23 | 権利形態表示 | 閲覧 | 所有権 / 定期借地 |
| 24 | 総戸数表示 | 閲覧 | ○戸 |
| 25 | 引渡時期表示 | 閲覧 | 新築のみ。例: "2027年9月上旬予定" |
| 26 | 月額支払い表示 | 閲覧 | 中古のみ。ローン条件での月額返済額を自動計算 |

#### 通勤時間セクション

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 27 | 通勤時間表示 | 閲覧 | Playground / M3Career への所要時間をバッジ表示 |
| 28 | Google Maps で経路確認 | バッジタップ | 物件→目的地の公共交通機関ルートを Google Maps で表示 |
| 29 | 通勤時間計算 | 「通勤時間を計算する」ボタン | MKDirections で計算 → キャッシュ保存。ボタン押下時に触覚フィードバック + ProgressView でローディング表示。計算完了時に成功/警告の触覚フィードバック |
| 29b | 通勤時間再検索 | 「正確な経路を再検索」ボタン | フォールバック概算（経路情報取得不可）の場合に表示。再計算を実行しローディング表示 |
| 30 | 複数駅展開 | セクションタップ | 複数最寄り駅がある場合にアコーディオン展開 |

#### 住まいサーフィン評価セクション

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 31 | 沖式儲かる確率 | 閲覧 | ○% 表示 |
| 32 | 沖式中古時価 | 閲覧 | 70㎡換算の時価（万円） |
| 33 | m²割安額 | 閲覧 | 万円/㎡、割安/適正/割高の判定 |
| 34 | 中古値上がり率 | 閲覧 | ○% 表示 |
| 35 | 駅ランキング | 閲覧 | 例: "3/12" |
| 36 | 区ランキング | 閲覧 | 例: "8/45" |
| 37 | お気に入りスコア | 閲覧 | 点数表示 |
| 38 | 購入判定 | 閲覧 | バッジ表示（例: "購入が望ましい"） |
| 39 | レーダーチャート | 閲覧 | 6軸レーダーチャートで偏差値を視覚化 |
| 40 | 住まいサーフィンページを開く | リンクタップ | アプリ内 Safari で住まいサーフィンの物件ページを表示 |

#### 値上がりシミュレーションセクション

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 41 | 予測価格チャート | 閲覧 | 楽観/標準/悲観 × 5年後・10年後のバーチャート |
| 42 | 含み益チャート | 閲覧 | 予測価格 − ローン残高のバーチャート |
| 43 | ローン残高表示 | 閲覧 | 5年後・10年後の残債 |

#### 成約相場セクション（MarketDataSectionView）

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 44 | 相場乖離率カード | 閲覧 | 掲載価格 vs 類似物件成約相場の乖離率・差額を表示 |
| 45 | マッチ精度バッジ | 閲覧 | 比較データのマッチ精度（高/中/低）をバッジ表示 |
| 46 | エリア相場グリッド | 閲覧 | 類似物件相場、区トレンド、前年比を3カラムで表示 |
| 47 | 駅レベル比較 | 閲覧 | 駅圏相場・物件との乖離率・トレンド・前年比を表示。乖離率はバックエンド算出値を優先し、未算出の場合は iOS 側で `priceMan × 10000 / areaM2 ÷ 駅圏中央値` をフォールバック計算 |
| 48 | 同一マンション成約事例 | 閲覧 | 同一マンション候補の成約事例を最大5件表示 |
| 49 | 四半期推移チャート | 閲覧 | 区（5年分）・駅の m²単価の四半期推移を折れ線チャートで表示。X軸は年ラベルのみ（Q1位置）、四半期ごとのデータポイントで推移を描画 |

#### エリア人口動態セクション（PopulationSectionView）

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 50 | 人口・世帯数サマリー | 閲覧 | 区の人口、世帯数、前年比、5年変動を4カラムで表示 |
| 51 | 人口推移チャート | 閲覧 | 区の人口推移を折れ線+エリアチャートで表示（monotone 補間）。AreaMark は yMin 基準の明示的ベースライン、Y軸ラベルは stride に応じた動的フォーマット（≥1→整数万、≥0.1→小数1桁万、その他→小数2桁万）でコンパクト表示 |

#### ハザード情報セクション

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 52 | ハザードチップ表示 | 閲覧 | 洪水、内水、土砂、高潮、津波、液状化の各リスクレベルをチップで表示 |
| 53 | ハザードガイド | DisclosureGroup タップ | 各ハザードの意味・注意点の解説を展開/折りたたみ |

#### 周辺物件セクション

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 54 | 周辺物件一覧 | セクションヘッダータップ | アコーディオンで展開/折りたたみ |
| 55 | 周辺物件詳細 | 行タップ | アプリ内 Safari で住まいサーフィンの物件ページを表示 |

#### 価格判定セクション

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 56 | 価格判定一覧 | セクションヘッダータップ | アコーディオンで展開/折りたたみ |

#### 外部リンク

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 57 | SUUMO/HOME'S ページ | リンクタップ | アプリ内 Safari で物件詳細ページを表示 |
| 58 | 住まいサーフィンページ | リンクタップ | アプリ内 Safari で住まいサーフィンページを表示 |

---

### 4.7 物件比較画面（ComparisonView）

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | 閉じる | ツールバーボタン | Sheet を閉じる |
| 2 | 横スクロール比較 | 横スワイプ | 2〜4件の物件を横並びテーブルで比較 |
| 3 | 基本情報比較 | 閲覧 | 価格、間取り、面積、築年、徒歩、階数、総戸数、権利形態 |
| 4 | 住まいサーフィン評価比較 | 閲覧 | 儲かる確率、値上がり率、購入判定（データがある場合） |
| 5 | 成約相場比較 | 閲覧 | 相場データがある物件の比較（データがある場合） |
| 6 | 人口動態比較 | 閲覧 | 人口データがある物件の比較（データがある場合） |
| 7 | 件数不足表示 | 自動 | 2件未満の場合に ContentUnavailableView を表示 |

---

### 4.8 地図タブ（MapTabView）

#### 地図操作

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | 地図閲覧 | ピンチ・パン | MapKit で自由にズーム・スクロール |
| 2 | 現在地表示 | 左下ボタンタップ | CLLocationManager で現在地に移動・中心表示 |
| 3 | 物件ピン表示 | 自動 | 全物件を地図上にピンで表示 |
| 4 | ピン色分け | 自動 | 中古（青●）/ 新築（緑●）/ いいね済み（赤♥） |

#### 物件操作

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 5 | 物件ポップアップ | ピンタップ | 物件概要（名前、価格、面積等）+ いいねボタンのポップアップ |
| 6 | 物件詳細表示 | ポップアップタップ | Sheet で物件詳細画面を表示 |
| 7 | 地図からいいね | ポップアップのハートタップ | いいね ON/OFF → Firestore 同期 |

#### ツールバー

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 8 | データ更新 | 更新ボタン | JSON URL から最新データを取得 |
| 9 | ハザードマップ表示 | ハザードボタン | ハザードレイヤー設定シートを表示 |
| 10 | フィルタ | フィルタボタン | フィルタシートを表示 |

#### ハザードマップオーバーレイ（シート内）

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 11 | 洪水浸水想定 | トグル ON/OFF | 国土地理院タイルを地図に重畳 |
| 12 | 内水浸水想定 | トグル ON/OFF | 同上 |
| 13 | 土砂災害警戒区域 | トグル ON/OFF | 同上 |
| 14 | 高潮浸水想定 | トグル ON/OFF | 同上 |
| 15 | 津波浸水想定 | トグル ON/OFF | 同上 |
| 16 | 液状化（地形分類） | トグル ON/OFF | 治水地形分類図（`lcmfc2`）タイルを重畳。旧河道・後背湿地等の地形からリスクを判読 |
| 17 | 浸水継続時間 | トグル ON/OFF | 同上 |
| 18 | 家屋倒壊（氾濫流） | トグル ON/OFF | 同上 |
| 19 | 家屋倒壊（河岸侵食） | トグル ON/OFF | 同上 |
| 20 | 揺れやすさ（地形分類） | トグル ON/OFF | 治水地形分類図（`lcmfc2`）タイルを重畳。地形から揺れやすさを判読 |
| 21 | 各レイヤー情報 | インフォボタン | 各ハザードレイヤーの解説をシートで表示 |

#### 東京都地域危険度オーバーレイ（シート内）

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 22 | 建物倒壊危険度 | トグル ON/OFF | GeoJSON → MKPolygon でランク1-5色分け表示 |
| 23 | 火災危険度 | トグル ON/OFF | 同上 |
| 24 | 総合危険度 | トグル ON/OFF | 同上 |
| 25 | 各レイヤー情報 | インフォボタン | 各危険度レイヤーの解説をシートで表示 |

#### プリセット操作

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 26 | 重要3項目 ON | ボタン | 洪水 + 液状化（地形分類） + 建物倒壊 + 淡色地図を一括 ON |
| 27 | すべて ON | ボタン | 全ハザード・地域危険度レイヤーを ON |
| 28 | すべて OFF | ボタン | 全レイヤーを OFF |
| 29 | 淡色地図 | トグル ON/OFF | ベースマップを淡色に切替（ハザードを見やすく） |

#### エラー・状態表示

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 30 | 更新中オーバーレイ | 自動 | データ更新中に ProgressView + Material オーバーレイ |
| 31 | エラーオーバーレイ | タップ | データ取得エラー表示 → タップでアラート（再取得 or 閉じる） |
| 32 | ジオコーディング失敗 | 自動 | 座標変換に失敗した件数を表示 |

---

### 4.9 設定画面（SettingsView）

#### 通知設定

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | 通知許可確認 | 自動 | 通知の許可状態を表示 |
| 2 | 通知を有効にする | ボタン | 端末の通知設定画面に遷移 |
| 3 | 通知を許可する | ボタン | 通知許可を初回リクエスト |
| 4 | 通知回数設定 | Stepper | 1日の通知回数を0〜6回で設定 |
| 5 | 通知時刻設定 | DatePicker | 通知回数分の配信時刻を個別設定 |
| 6 | コメント通知 | トグル ON/OFF | 新しいコメントのローカル通知を有効/無効 |

#### データ管理

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 7 | フルリフレッシュ | ボタン | 確認ダイアログ → ETag クリア + 全件再取得 |
| 8 | 最終更新時刻 | 閲覧 | 前回データ取得の日時を表示 |

#### カスタム URL 設定

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 9 | カスタム URL 展開 | DisclosureGroup タップ | 詳細 URL 設定セクションの展開/折りたたみ |
| 10 | 中古 JSON URL 入力 | テキストフィールド | 中古物件 JSON の URL を入力 |
| 11 | 新築 JSON URL 入力 | テキストフィールド | 新築物件 JSON の URL を入力 |
| 12 | URL 保存 | 保存ボタン | 入力した URL を UserDefaults に保存 → 確認アラート |
| 13 | デフォルト URL に戻す | ボタン | 確認ダイアログ → URL をデフォルトにリセット |
| 14 | カスタム URL 説明 | インフォボタン | カスタム URL の使い方をアラートで表示 |

#### スクレイピング管理

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 15 | スクレイピング条件 | ボタン | ScrapingConfigView を Sheet で表示 |
| 16 | スクレイピングログ | ボタン | ScrapingLogView を Sheet で表示 |

#### アカウント

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 17 | ユーザー情報表示 | 閲覧 | 名前・メールアドレスを表示 |
| 18 | ログアウト | ボタン | 確認ダイアログ → Firebase Auth サインアウト |

#### その他

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 19 | 使い方ガイド | ボタン | WalkthroughView を fullScreenCover で再表示 |

---

### 4.10 スクレイピング条件設定画面（ScrapingConfigView）

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | 閉じる | ツールバーボタン | Sheet を閉じる |
| 2 | 保存 | ツールバーボタン | 条件を Firestore に保存 → 成功アラート → 閉じる |
| 3 | 価格下限入力 | テキストフィールド | 数値入力（万円） |
| 4 | 価格上限入力 | テキストフィールド | 数値入力（万円） |
| 5 | 面積下限入力 | テキストフィールド | 数値入力（㎡） |
| 6 | 面積上限入力 | テキストフィールド | 数値入力（㎡、任意） |
| 7 | 駅徒歩設定 | Stepper | 1〜20分で設定 |
| 8 | 竣工年設定 | Picker | 年を選択 |
| 9 | 総戸数設定 | テキストフィールド | 数値入力 |
| 10 | 間取り選択 | チップタップ | 1LDK系, 2LDK系, 3LDK系 等を ON/OFF |
| 11 | 路線選択 | チップタップ | JR, 東京メトロ, 都営, 東急, 京急 等を ON/OFF |
| 12 | 保存成功アラート | 自動 | 保存成功時に「保存しました」アラート |
| 13 | 保存失敗アラート | 自動 | 保存失敗時にエラーメッセージアラート |
| 14 | 未認証表示 | 自動 | Firebase 未認証の場合にログイン案内を表示 |
| 15 | ローディング | 自動 | 保存中にツールバーに ProgressView を表示 |

---

### 4.11 スクレイピングログ画面（ScrapingLogView）

| # | 機能 | 操作 | 詳細 |
|---|------|------|------|
| 1 | 閉じる | ツールバーボタン | Sheet を閉じる |
| 2 | ログ閲覧 | 閲覧 | 最新パイプライン実行のステータス・タイムスタンプ・ログ本文 |
| 3 | ログ展開/折りたたみ | 「ログ本文」ボタン | ログテキストの表示/非表示を切替 |
| 4 | ログ全文コピー | コピーボタン | ログ全文をクリップボードにコピー（ツールバー + 本文内の2箇所） |
| 5 | コピー完了表示 | 自動 | コピー後2秒間「コピーしました」を表示 |
| 6 | Pull-to-refresh | 下に引く | Firestore から最新ログを再取得 |
| 7 | 再試行 | ボタン | 取得失敗時に再試行 |
| 8 | ローディング | 自動 | 読み込み中に ProgressView を表示 |
| 9 | 切り詰め通知 | 自動 | ログが切り詰められている場合に警告バッジ表示 |
| 10 | ステータス色分け | 自動 | ログのステータスに応じて色分け表示 |

---

### 4.12 グローバル機能（画面横断）

| # | 機能 | 画面 | 詳細 |
|---|------|------|------|
| 1 | オフラインバナー | 全タブ | ネットワーク未接続時に「オフラインです」バナーを画面上部に表示 |
| 2 | タブ切替 | 全体 | 中古 / 新築 / 地図 / お気に入り / 設定 の5タブ |
| 3 | プッシュ通知ハンドリング | 全体 | FCM 通知タップ → 中古タブに遷移 |
| 4 | コメント通知ハンドリング | 全体 | コメント通知タップ → 該当物件の詳細画面を表示 |
| 5 | 自動データ更新 | 全体 | フォアグラウンド復帰時に15分経過で自動更新 |
| 6 | バックグラウンド更新 | 全体 | BGAppRefreshTask で定期的に JSON 取得 → 新着検出 → ローカル通知 |
| 7 | フィルタ独立管理 | 中古・新築・地図・お気に入り | FilterStore をタブごとに独立保持（OOUI: タブ間で干渉しない） |
| 8 | Firestore アノテーション同期 | 全体 | アプリ起動時に Firestore からいいね・コメント・写真メタを取得 |
| 9 | 保存エラーアラート | 全体 | SwiftData 保存エラー時にアラートを表示 |
| 10 | キーボード自動非表示 | 全体 | タブ切替時にキーボードを自動で閉じる |

---

### 4.13 機能数サマリー

| 画面 | 機能数 |
|------|--------|
| ログイン | 4 |
| オンボーディング | 7 |
| 中古/新築一覧 | 22 |
| お気に入り | 22 + 3 = 25 |
| フィルタシート | 13 |
| 物件詳細 | 58 |
| 物件比較 | 7 |
| 地図 | 32 |
| 設定 | 19 |
| スクレイピング条件 | 15 |
| スクレイピングログ | 10 |
| グローバル | 10 |
| **合計** | **約222機能** |

## 5. スクレイピングツール仕様

### 5.1 データソース

| ソース | 種別 | URL パターン | 状態 |
|--------|------|-------------|------|
| **SUUMO 中古** | 中古マンション | `suumo.jp/ms/chuko/tokyo/sc_{ward}/?kb={min}&kt={max}&mb={area}&mt=9999999` | 有効 |
| **SUUMO 新築** | 新築マンション | `suumo.jp/jj/bukken/ichiran/JJ011FC001/?ar=030&bs=010&ta=13` | 有効 |
| ~~HOME'S 中古~~ | 中古マンション | `homes.co.jp/mansion/chuko/tokyo/23ku/list/` | **無効**（WAF により実用的な取得が困難） |
| ~~HOME'S 新築~~ | 新築マンション | `homes.co.jp/mansion/shinchiku/tokyo/list/` | **無効**（同上） |
| **住まいサーフィン** | 評価データ | `sumai-surfin.com`（ログイン必要） | 有効 |
| **国土地理院** | ハザードデータ | GSI タイル（`disaportaldata.gsi.go.jp`） | 有効 |
| **東京都** | 地域危険度 | GeoJSON（GitHub raw） | 有効 |

### 5.2 スクレイピングパイプライン

```
1. main.py（スクレイピング実行）
   ├── suumo_scraper.py       → SUUMO 中古物件取得
   ├── suumo_shinchiku_scraper.py → SUUMO 新築物件取得
   ├── (homes_scraper.py)      → HOME'S 中古（現在無効）
   └── (homes_shinchiku_scraper.py) → HOME'S 新築（現在無効）
       ↓ フィルタ・重複除去
2. results/latest.json, results/latest_shinchiku.json 出力
   check_changes.py → 前回との差分チェック（変更なし → 早期終了）
       ↓
3. エンリッチメント（update_listings.sh 内で順次実行）
   ├── （latest.json / latest_shinchiku.json を .backup に退避後、enricher 実行）
   ├── （enrichment 後に JSON 検証；破損時は .backup から復元）
   ├── build_units_cache.py   → 総戸数・階数・権利形態キャッシュ更新（SUUMO 詳細ページ取得）
   ├── merge_detail_cache.py  → 詳細キャッシュを latest.json にマージ
   ├── sumai_surfin_enricher.py → 住まいサーフィン評価付与（ss_address 取得含む）
   ├── build_map_viewer.py    → 地図ビューア生成（中古+新築、ピン色: 青=中古/緑=新築。argparse: json_path, --previous, --shinchiku, --limit, --output）
   ├── embed_geocode.py       → ジオコーディング（住所→座標、ss_address を優先使用）
   ├── geocode_cross_validator.py → 座標の相互検証 + 修正試行
   ├── hazard_enricher.py     → ハザード情報付与
   ├── floor_plan_enricher.py → 間取り図画像URL付与（HOME'S 無効化により現在は自動スキップ。SUUMOはbuild_units_cache経由で付与済み）
   ├── upload_floor_plans.py  → 間取り図画像をFirebase Storageにアップロード（URL永続化）
   ├── commute_enricher.py    → 通勤時間付与（駅名ベースのドアtoドア概算）
   ├── reinfolib_enricher.py  → 不動産情報ライブラリ成約相場付与（事前構築キャッシュ参照）
   └── estat_enricher.py      → e-Stat 人口動態付与（事前構築キャッシュ参照）
       ↓
4. generate_report.py → Markdown レポート生成
5. send_push.py       → FCM プッシュ通知（新着ありの場合）
6. upload_scraping_log.py → Firestore にログ保存
7. slack_notify.py    → Slack 通知（1日1回 6:30 JST のみ）
8. git commit & push
```

> **Note**: `commute_enricher.py` はパイプラインで有効化済み。駅名ベースのドアtoドア概算を `commute_info` として JSON に付与し、iOS アプリでの即時表示に使用。iOS 実機では MKDirections でより正確な経路を取得して上書き。

### 5.3 スクレイパー詳細

#### 5.3.1 SUUMO 中古（suumo_scraper.py）

| 項目 | 詳細 |
|------|------|
| **パース対象** | `div.property_unit-content` / カセットレイアウト |
| **取得フィールド** | name, price, address, station_line, walk_min, area_m2, layout, built_year, floor, ownership |
| **総戸数** | `building_units.json`（詳細ページキャッシュ）から取得 |
| **URL プリフィルタ** | `apply_filter=True` 時、価格（`kb`/`kt`）・面積（`mb`/`mt`）を URL パラメータに付与しサーバーサイドで絞り込み。ページ数を大幅削減（例: 千代田区 100ページ→0ページ） |
| **早期打ち切り** | 連続20ページで新規通過0件の区はスキップ（`EARLY_EXIT_PAGES=20`） |
| **出力** | `SuumoListing` dataclass |

#### 5.3.2 ~~HOME'S 中古（homes_scraper.py）~~ — 現在無効

> **無効化理由**: AWS WAF が GitHub Actions の IP を積極的にブロックし、1ページあたり最大7分のリトライが発生。30ページ処理しても通過0件という状況が続いたため無効化。コードは `--source homes` / `--source both` で再有効化可能。

#### 5.3.3 SUUMO 新築（suumo_shinchiku_scraper.py）

| 項目 | 詳細 |
|------|------|
| **取得フィールド** | 基本情報 + 価格レンジ、面積レンジ、間取りレンジ、引渡時期 |
| **出力** | `SuumoShinchikuListing` dataclass |

#### 5.3.4 ~~HOME'S 新築（homes_shinchiku_scraper.py）~~ — 現在無効

> 中古と同様の理由で無効化。

### 5.4 フィルタ・重複除去

#### フィルタ条件（`apply_conditions`）

各スクレイパーの結果に対して以下の条件でフィルタ（2段階フィルタ）:

1. **URL プリフィルタ**（SUUMO）: 価格・面積を URL パラメータでサーバーサイド絞り込み → 取得ページ数を大幅削減
2. **ローカルフィルタ**（`apply_conditions`）: 以下の全条件で精密フィルタ

- 東京23区以内
- 価格: `PRICE_MIN_MAN`〜`PRICE_MAX_MAN`
- 面積: `AREA_MIN_M2` 以上
- 間取り: `LAYOUT_PREFIX_OK` に前方一致
- 築年: `BUILT_YEAR_MIN` 以降
- 徒歩: `WALK_MIN_MAX` 以内
- 総戸数: `TOTAL_UNITS_MIN` 以上
- 路線: `ALLOWED_LINE_KEYWORDS` のいずれかを含む
- 駅乗降客数: `STATION_PASSENGERS_MIN` 以上（0 = フィルタなし）

#### 重複除去（`dedupe_listings`）

`listing_key` = (name, layout, area, price, address, built_year, station_line, walk_min) の組み合わせで一意化。重複件数は `duplicate_count` に記録。

### 5.5 エンリッチャー

#### 5.5.1 ハザードエンリッチャー（hazard_enricher.py）

国土地理院タイルと東京都地域危険度 GeoJSON から以下を付与:

- 洪水浸水深、内水浸水深、土砂災害警戒、高潮浸水深、津波浸水深
- 液状化（地形分類）— 治水地形分類図 `lcmfc2` で代替
- 建物倒壊危険度、火災危険度、総合危険度

#### 5.5.2 住まいサーフィンエンリッチャー（sumai_surfin_enricher.py）

| 項目 | 詳細 |
|------|------|
| **認証** | `SUMAI_USER` / `SUMAI_PASS` 環境変数 |
| **ブラウザ自動操作** | Playwright（`sumai_surfin_browser.py`） |
| **取得データ** | 沖式時価、儲かる確率、値上がり率、レーダーチャート、割安判定、ランキング等 |

**沖式中古時価70㎡換算のデータソース優先順位:**

| 優先度 | ソース | 説明 |
|--------|--------|------|
| 1（最優先） | 検索結果一覧ページのカード | `_extract_search_result_inline()` で物件カードから直接抽出。ヘルプ文の誤マッチリスクがなく最も信頼性が高い |
| 2（フォールバック） | 物件詳細ページ | `_extract_oki_price_chuko()` で HTML 正規表現抽出。ページ下部のヘルプ文「例：X,XXX万円」の例示値を誤取得しないよう、マッチ直前の「例：」パターンを除外する |

#### 5.5.3 不動産情報ライブラリエンリッチャー（reinfolib_enricher.py）

| 項目 | 詳細 |
|------|------|
| **データソース** | `data/reinfolib_prices.json`, `data/reinfolib_trends.json`（事前構築キャッシュ） |
| **付与データ** | 区・駅レベルの成約 m² 単価、相場乖離率、前年比、四半期推移（区: 過去5年分）、同一マンション成約事例 |
| **キャッシュ構築** | `reinfolib_cache_builder.py`（`YEARS_BACK=5` で過去5年分の四半期推移を取得）/ `fetch_station_prices.py`（別ワークフローで実行） |

#### 5.5.4 e-Stat 人口動態エンリッチャー（estat_enricher.py）

| 項目 | 詳細 |
|------|------|
| **データソース** | `data/estat_population.json`（事前構築キャッシュ） |
| **付与データ** | 区の人口、世帯数、前年比、5年変動、年次推移 |
| **キャッシュ構築** | `estat_population_builder.py`（別ワークフローで実行） |

#### 5.5.5 間取り図画像エンリッチャー（floor_plan_enricher.py）

| 項目 | 詳細 |
|------|------|
| **データソース** | SUUMO: `build_units_cache.py` → `parse_suumo_detail_html()` で詳細ページ HTML から `alt="間取り図"` の img タグを抽出（HOME'S は無効化のため現在未使用） |
| **付与データ** | `floor_plan_images`: 間取り図画像 URL の配列（SUUMO はリサイズ URL w=1200&h=900） |
| **HTMLキャッシュ** | SUUMO: `data/html_cache/`（build_units_cache.py と共有） |
| **Firebase Storage 永続化** | `upload_floor_plans.py` が画像を Firebase Storage `floor_plans/{hash}.{ext}` にアップロードし、URL をトークン付きダウンロード URL に置き換える。マニフェスト（`data/floor_plan_storage_manifest.json`）で元 URL → Firebase URL のマッピングを保持し、重複アップロードを回避。`FIREBASE_SERVICE_ACCOUNT` 未設定時はスキップ |
| **iOS 側フィールド** | `Listing.floorPlanImagesJSON`（JSON 文字列 → `parsedFloorPlanImages: [URL]` で URL 配列に変換。URL は Firebase Storage のダウンロード URL） |

### 5.6 成約実績フィード構築（build_transaction_feed.py）

首都圏（東京都・神奈川県・埼玉県・千葉県）の成約実績データを取得・フィルタ・ジオコード・集約して iOS アプリ向け `transactions.json` を生成するバッチスクリプト。

| 項目 | 詳細 |
|------|------|
| **入力** | reinfolib API（成約価格情報 `priceClassification=02`）、`data/shutoken_city_codes.json`、`data/geocode_cache.json`、`data/station_cache.json` |
| **出力** | `results/transactions.json` |
| **フィルタ条件** | `config.py` の購入条件（価格帯・面積・間取り・築年）を適用 |
| **ジオコーディング** | 町丁目アドレス → 緯度経度（geocode_cache.json 優先、不足分は Nominatim API） |
| **最寄駅推定** | ジオコーディング座標 + station_cache.json → Haversine 距離で最近傍駅を算出、直線距離 80m/分で徒歩推定 |
| **建物グルーピング** | `(districtCode, builtYear)` の組で推定建物グループを構成。グループ別に取引件数、価格帯、平均 m² 単価を集計 |
| **物件名推定** | `latest.json` / `latest_shinchiku.json` の既存スクレイピングデータとクロスリファレンス。市区町村+町丁目+築年（±1年）でマッチした物件名を `estimated_building_name` として付与。複数候補は " / " 区切り |
| **実行間隔** | 四半期に1回（`update_listings.sh` から呼び出し、`REINFOLIB_API_KEY` 設定時のみ実行） |
| **CLI オプション** | `--quarters N`（取得四半期数、デフォルト4）、`--output PATH`（出力先） |

#### transactions.json 構造

```json
{
  "transactions": [
    {
      "id": "tx-xxxxxxxxx",
      "prefecture": "東京都",
      "ward": "江東区",
      "district": "有明",
      "district_code": "131080020",
      "price_man": 7800,
      "area_m2": 70.0,
      "m2_price": 1114286,
      "layout": "3LDK",
      "built_year": 2019,
      "structure": "RC",
      "trade_period": "2025Q2",
      "nearest_station": "有明テニスの森",
      "estimated_walk_min": 5,
      "latitude": 35.6358,
      "longitude": 139.7908,
      "building_group_id": "131080020-2019",
      "estimated_building_name": "シティタワー有明"
    }
  ],
  "building_groups": [
    {
      "group_id": "131080020-2019",
      "ward": "江東区",
      "district": "有明",
      "built_year": 2019,
      "transaction_count": 5,
      "price_range_man": [6500, 9800],
      "avg_m2_price": 1050000,
      "estimated_building_name": "シティタワー有明"
    }
  ],
  "metadata": { ... }
}
```

### 5.7 通勤時間ツール

| ファイル | 用途 | ステータス |
|---------|------|---------|
| **commute.py** | コアロジック: 駅名パース、通勤時間計算、表示文字列生成 | パイプラインで使用 |
| **commute_enricher.py** | 駅名ベースのドアtoドア概算を `commute_info` として JSON に付与。`--force` で既存データを再計算して上書き | パイプラインで使用 |
| **commute_audit.py** | 手動監査用 HTML 生成（Google Maps との比較） | 監査用 |
| **commute_auto_audit.py** | Playwright 自動監査（Google Maps に到着 8:30 で経路検索 → 所要時間を抽出） | 監査用 |
| **data/commute_playground.json** | 駅名 → Playground までの電車時間（分）のルックアップテーブル | `commute_auto_audit.py` で更新 |
| **data/commute_m3career.json** | 駅名 → M3Career までの電車時間（分）のルックアップテーブル | `commute_auto_audit.py` で更新 |

#### 5.6.1 通勤エンリッチャー（commute_enricher.py）オプション

| オプション | 説明 |
|-----------|------|
| `--force` | 既存の `commute_info` があってもスキップせず、再計算して上書きする。指定しない場合は既存データがある物件はスキップ（デフォルト動作）。`enrich_commute()` の `force: bool = False` パラメータに対応。 |

### 5.7 分析・予測

| ファイル | 機能 |
|---------|------|
| **shared_utils.py** | 共通ユーティリティ（`ward_from_address`, `calc_loan_residual_10y_yen`、ローン定数） |
| **price_predictor.py** | `MansionPricePredictor`：CSV データに基づく価格予測 |
| **asset_score.py** | 資産ランク S/A/B/C の算出（含み益率ベース） |
| **asset_simulation.py** | 10年シミュレーション。`simulate_10year_from_listing(listing, predictor=...)` で Predictor を再利用可能。`simulate_batch(listings)` で複数物件を一括処理（CSV 読込1回のみ） |
| **future_estate_predictor.py** | 10年価格予測（3シナリオ） |
| **loan_calc.py** | 50年ローン月額返済額計算 |

`price_predictor` と `future_estate_predictor` は `shared_utils` を利用。CSV/JSON 読込は try/except で囲み、ファイル欠損時は警告を出して空 DataFrame・デフォルトで続行。

### 5.8 レポート生成

`generate_report.py` が以下のレポートを Markdown で生成:

| セクション | 内容 |
|-----------|------|
| **新着物件** | 前回から追加された物件 |
| **価格変更** | 前回から価格が変わった物件 |
| **掲載終了** | 前回から消えた物件 |
| **区別一覧** | 区ごとの物件リスト |
| **駅別一覧** | 駅ごとの物件リスト |
| **オプション** | 資産ランク、通勤時間、ローン情報（有効な場合） |

### 5.9 出力ファイル

| ファイル | 形式 | 内容 |
|---------|------|------|
| `results/latest.json` | JSON | 中古マンション物件リスト |
| `results/latest_shinchiku.json` | JSON | 新築マンション物件リスト |
| `results/report/report.md` | Markdown | 差分レポート |
| `results/map_viewer.html` | HTML | 地図ビューア（中古+新築。ピン色: 青=中古、緑=新築） |
| `data/commute_playground.json` | JSON | Playground 通勤時間マスター |
| `data/commute_m3career.json` | JSON | M3Career 通勤時間マスター |
| `data/geocode_cache.json` | JSON | ジオコーディングキャッシュ |
| `data/building_units.json` | JSON | 総戸数・階数・権利形態キャッシュ |
| `data/reinfolib_prices.json` | JSON | 不動産情報ライブラリ区別成約相場キャッシュ |
| `data/reinfolib_trends.json` | JSON | 不動産情報ライブラリ四半期推移キャッシュ（過去5年分） |
| `data/reinfolib_raw_transactions.json` | JSON | 不動産情報ライブラリ生取引データ |
| `data/station_price_history.json` | JSON | 駅別成約価格推移キャッシュ |
| `data/estat_population.json` | JSON | e-Stat 区別人口・世帯数キャッシュ |
| `data/sumai_surfin_cache.json` | JSON | 住まいサーフィン検索結果キャッシュ |
| `data/station_passengers.json` | JSON | 駅乗降客数データ |
| `data/shutoken_city_codes.json` | JSON | 首都圏（1都3県）市区町村コード一覧 |
| `results/transactions.json` | JSON | 首都圏成約実績フィード（iOS アプリ向け） |

---

## 6. データモデル

### 6.1 Listing（SwiftData @Model）

iOS アプリのメインデータモデル。`scraping-tool/results/latest.json` / `latest_shinchiku.json` の1件に対応。

#### 基本情報

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `source` | String? | データソース（"suumo", "homes"） |
| `url` | String | 物件詳細ページ URL |
| `name` | String | 物件名 |
| `priceMan` | Int? | 価格（万円） |
| `address` | String? | 住所 |
| `ssAddress` | String? | 住まいサーフィンから取得した番地レベルの詳細住所（パイプライン側で付与。ジオコーディング精度向上に使用） |
| `stationLine` | String? | 最寄り路線・駅名 |
| `walkMin` | Int? | 駅徒歩（分） |
| `areaM2` | Double? | 専有面積（㎡） |
| `layout` | String? | 間取り（例: "3LDK"） |
| `builtStr` | String? | 築年月（文字列） |
| `builtYear` | Int? | 築年（西暦） |
| `totalUnits` | Int? | 総戸数 |
| `floorPosition` | Int? | 所在階 |
| `floorTotal` | Int? | 階建て |
| `floorStructure` | String? | 構造（例: "RC"） |
| `ownership` | String? | 権利形態 |
| `managementFee` | Int? | 管理費（円/月。SUUMO/HOME'S 詳細ページから取得） |
| `repairReserveFund` | Int? | 修繕積立金（円/月。SUUMO/HOME'S 詳細ページから取得） |
| `listWardRoman` | String? | 区（ローマ字） |
| `fetchedAt` | Date | 取得日時 |
| `addedAt` | Date | 初回追加日時（同期で上書きしない） |

#### ユーザーデータ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `memo` | String? | メモ（レガシー、コメントに移行済み） |
| `isLiked` | Bool | いいね状態 |
| `commentsJSON` | String? | コメント JSON（Firestore 同期） |
| `isDelisted` | Bool | 掲載終了フラグ |
| `isNew` | Bool | 前回同期時に存在しなかった新着フラグ（同期ごとにリセット。304 応答時も確実にリセット） |
| `photosJSON` | String? | 内見写真メタデータ JSON |

#### 新築固有フィールド

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `propertyType` | String | "chuko" or "shinchiku" |
| `priceMaxMan` | Int? | 価格帯上限（万円） |
| `areaMaxM2` | Double? | 面積幅上限（㎡） |
| `deliveryDate` | String? | 引渡時期 |

#### 位置情報

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `latitude` | Double? | 緯度 |
| `longitude` | Double? | 経度 |
| `duplicateCount` | Int | 重複集約数 |

#### 住まいサーフィン評価データ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `ssLookupStatus` | String? | 住まいサーフィン検索ステータス（"found" / "not_found" / "no_data" / nil=未検索） |
| `ssProfitPct` | Int? | 沖式儲かる確率 (%) |
| `ssOkiPrice70m2` | Int? | 沖式中古時価（万円, 70㎡換算） |
| `ssM2Discount` | Int? | m²割安額（万円/㎡）、負値=割安 |
| `ssValueJudgment` | String? | 割安判定（"割安"/"適正"/"割高"） |
| `ssStationRank` | String? | 駅ランキング |
| `ssWardRank` | String? | 区ランキング |
| `ssSumaiSurfinURL` | String? | 住まいサーフィンページ URL |
| `ssAppreciationRate` | Double? | 中古値上がり率 (%)。取得にはログインが必須（必ずログイン後に取得する）。SS データが存在するが未取得の場合は UI で「—」を表示 |
| `ssFavoriteCount` | Int? | お気に入りランキングスコア |
| `ssPurchaseJudgment` | String? | 購入判定 |
| `ssRadarData` | String? | レーダーチャート偏差値 JSON |

#### シミュレーションデータ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `ssSimBest5yr` / `ssSimBest10yr` | Int? | 楽観シナリオ予測価格（万円） |
| `ssSimStandard5yr` / `ssSimStandard10yr` | Int? | 標準シナリオ予測価格 |
| `ssSimWorst5yr` / `ssSimWorst10yr` | Int? | 悲観シナリオ予測価格 |
| `ssLoanBalance5yr` / `ssLoanBalance10yr` | Int? | ローン残高 |
| `ssSimBasePrice` | Int? | シミュレーション基準価格 |
| `ssNewM2Price` | Int? | 新築㎡単価 |
| `ssForecastM2Price` | Int? | 予測㎡単価 |
| `ssForecastChangeRate` | Double? | 予測変動率 |
| `ssPastMarketTrends` | String? | 過去の市場動向 JSON |
| `ssSurroundingProperties` | String? | 周辺物件 JSON |
| `ssPriceJudgments` | String? | 価格判定 JSON |

#### ハザード・通勤

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `hazardInfo` | String? | ハザード情報 JSON |
| `commuteInfoJSON` | String? | 通勤時間情報 JSON（パイプラインの `commute_info` から初期値を取り込み、MKDirections で上書き可能） |
| `reinfolibMarketData` | String? | 不動産情報ライブラリの成約価格相場データ JSON（パイプライン側で付与） |
| `estatPopulationData` | String? | e-Stat（総務省統計局）の人口・世帯数データ JSON（パイプライン側で付与） |

### 6.2 TransactionRecord（SwiftData @Model）

iOS アプリの成約実績データモデル。`scraping-tool/results/transactions.json` の1取引に対応。  
reinfolib API（不動産情報ライブラリ）の成約価格情報から、config.py の購入条件に合致するレコードを抽出したもの。

#### 取引情報

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `txId` | String | ユニーク ID（`@Attribute(.unique)`、"tx-" + MD5ハッシュ12桁） |
| `prefecture` | String | 都道府県（例: "東京都"） |
| `ward` | String | 市区町村（例: "江東区"） |
| `district` | String | 町丁目（例: "有明"） |
| `districtCode` | String | 町丁目コード（例: "131080020"） |
| `priceMan` | Int | 成約価格（万円） |
| `areaM2` | Double | 専有面積（㎡） |
| `m2Price` | Int | m²単価（円/㎡） |
| `layout` | String | 間取り（例: "3LDK"） |
| `builtYear` | Int | 築年（例: 2019） |
| `structure` | String | 構造（例: "RC", "SRC"） |
| `tradePeriod` | String | 取引時期（例: "2025Q2"） |

#### 推定位置情報

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `nearestStation` | String? | 推定最寄駅名（geocode + station_cache.json から算出） |
| `estimatedWalkMin` | Int? | 推定徒歩分（直線距離ベース、精度 ±2-3分） |
| `latitude` | Double? | ジオコーディング済み緯度（町丁目レベル） |
| `longitude` | Double? | ジオコーディング済み経度（町丁目レベル） |

#### グルーピング・推定物件名

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `buildingGroupId` | String? | 推定建物グループ ID（"districtCode-builtYear"） |
| `estimatedBuildingName` | String? | スクレイピングデータとのクロスリファレンスで推定した物件名。複数候補は " / " 区切り |

#### 物件名推定ロジック

`build_transaction_feed.py` が `latest.json` / `latest_shinchiku.json` のスクレイピング済み物件データをリファレンスとして使用。  
マッチ条件: **市区町村名 + 町丁目名 + 築年（±1年）** が一致する物件の名前を候補として付与。  
複数候補がある場合は最大3件を " / " 区切りで連結。  
マッチしない場合は `null` となり、iOS アプリ側では「{市区町村}{町丁目} {築年}年築」を代替表示する。

#### データソース・制約

- **匿名データ**: 建物名は含まれない。町丁目+築年で推定建物をグルーピング。物件名は既存スクレイピングデータからの推定
- **最寄駅は推定値**: reinfolib API の成約データには駅情報がないため、ジオコーディング座標から最近傍駅を算出
- **対象範囲**: 首都圏（東京都・神奈川県・埼玉県・千葉県）
- **フィルタ済み**: config.py の購入条件（価格 7,500〜10,000万円、60㎡以上、2-3LDK、築20年以内）

### 6.3 TransactionFilter

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `priceMin` | Int? | 最低価格（万円） |
| `priceMax` | Int? | 最高価格（万円） |
| `layouts` | Set\<String\> | 間取りフィルタ |
| `wards` | Set\<String\> | 市区町村フィルタ（都道府県別に階層表示） |
| `stations` | Set\<String\> | 駅名フィルタ |
| `walkMax` | Int? | 推定徒歩上限（分） |
| `areaMin` | Double? | 面積下限（㎡） |
| `builtYearMin` | Int? | 築年下限 |
| `tradePeriods` | Set\<String\> | 取引時期フィルタ（例: "2025Q2"） |

**フィルタシートの市区町村表示**:  
`TransactionFilterSheet` ではフラットなリストではなく、都道府県別セクション（東京都→神奈川県→埼玉県→千葉県の順）に分けて表示。  
各都道府県セクションに「すべて」トグルボタンを設け、都道府県単位での一括選択/解除が可能。

**メソッド**

| メソッド | 説明 |
|---------|------|
| `apply(to records: [TransactionRecord]) -> [TransactionRecord]` | フィルタ条件を適用 |

### 6.5 ListingFilter

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `priceMin` | Int? | 最低価格（万円） |
| `priceMax` | Int? | 最高価格（万円） |
| `includePriceUndecided` | Bool | 価格未定を含む |
| `layouts` | Set\<String\> | 間取りフィルタ |
| `wards` | Set\<String\> | 区フィルタ |
| `stations` | Set\<String\> | 駅名フィルタ |
| `walkMax` | Int? | 徒歩上限（分） |
| `areaMin` | Double? | 面積下限（㎡） |
| `ownershipTypes` | Set\<OwnershipType\> | 権利形態フィルタ |
| `propertyType` | PropertyTypeFilter | 物件種別フィルタ |

**メソッド**

| メソッド | 説明 |
|---------|------|
| `apply(to listings: [Listing]) -> [Listing]` | フィルタ条件を `[Listing]` に適用して絞り込んだ結果を返す。View 側の前処理（お気に入り・座標有無・掲載終了除外など）の後に呼び出す想定。 |
| `extractWard(from address: String?) -> String?` | 住所から区名を抽出（例: "東京都江東区豊洲5丁目" → "江東区"） |
| `availableLayouts(from listings: [Listing]) -> [String]` | 一覧内に存在する間取りの一意リスト（フィルタシートの選択肢用） |
| `availableWards(from listings: [Listing]) -> Set\<String\>` | 一覧内に存在する区名のセット（フィルタシートの選択肢用） |
| `availableRouteStations(from listings: [Listing]) -> [RouteStations]` | 路線別駅名リスト（フィルタシートの選択肢用） |

**RouteStations**（ListingFilter.swift で定義）: `routeName` と `stationNames` を持つ Equatable 構造体。フィルタシートの路線・駅選択 UI で使用。

### 6.6 CommentData

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `id` | String | コメント ID（UUID） |
| `text` | String | コメント本文 |
| `authorName` | String | 投稿者名 |
| `authorId` | String | 投稿者 ID（Firebase UID） |
| `createdAt` | String | 作成日時（ISO 8601） |
| `editedAt` | String? | 編集日時（ISO 8601）。nil なら未編集 |

### 6.7 ScrapingConfig

Firestore で共有されるスクレイピング条件:

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `priceMinMan` | Int | 最低価格（万円） |
| `priceMaxMan` | Int | 最高価格（万円） |
| `areaMinM2` | Double | 最低面積（㎡） |
| `areaMaxM2` | Double? | 最高面積（㎡） |
| `walkMinMax` | Int | 徒歩上限（分） |
| `builtYearMin` | Int | 最低築年 |
| `totalUnitsMin` | Int | 最低総戸数 |
| `layoutPrefixOk` | [String] | 間取りプレフィックス |
| `allowedLineKeywords` | [String] | 路線キーワード |

### 6.8 キー定義

| キー名 | 構成要素 | 用途 |
|--------|---------|------|
| **identity_key** | name + layout + area_m2 + address + built_year + station_line + walk_min | 同一物件の判定（**価格を含まない**） |
| **listing_key** | name + layout + area_m2 + price + address + built_year + station_line + walk_min | 重複除去（**価格を含む**） |

---

## 7. Firebase 仕様

### 7.1 Firestore コレクション

#### annotations（ユーザーデータ）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| **ドキュメントID** | String | SHA256(identityKey) 先頭16文字 |
| `isLiked` | Boolean | いいね状態 |
| `comments` | Array | コメント配列（CommentData 形式） |
| `photos` | Array | 写真メタデータ配列 |

#### scraping_config（スクレイピング条件）

| ドキュメント | 内容 |
|------------|------|
| `default` | ScrapingConfig の全フィールド |

#### scraping_logs（実行ログ）

| ドキュメント | 内容 |
|------------|------|
| `latest` | 最新のスクレイピングパイプライン実行ログ |

### 7.2 Firestore セキュリティルール

```
annotations/{docId}        → 認証済みユーザーのみ読み書き
scraping_config/{docId}    → 認証済みユーザーのみ読み書き
```

GitHub Actions のサービスアカウント（Firebase Admin SDK）はルールの制約を受けない。

### 7.3 Firebase Storage ルール

```
photos/{docId}/{photoId}   → 認証済みユーザーのみ読み書き
                              サイズ上限: 10MB
                              コンテンツタイプ: image/*
floor_plans/{imageId}      → 認証済みユーザーのみ読み取り
                              書き込みは Admin SDK（パイプライン）のみ
                              ※ ダウンロード URL にトークンを含むため AsyncImage から直接読み込み可
```

### 7.4 Firebase Cloud Messaging

| 項目 | 詳細 |
|------|------|
| **トピック** | `new_listings` |
| **送信元** | GitHub Actions（`send_push.py`）→ FCM HTTP v1 API |
| **受信** | iOS アプリ（`PushNotificationService` / `AppDelegate`） |
| **トリガー** | スクレイピングで新着物件検出時 |

---

## 8. CI/CD パイプライン

### 8.1 GitHub Actions ワークフロー

**ファイル**: `.github/workflows/update-listings.yml`

#### トリガー

| トリガー | 条件 |
|---------|------|
| **スケジュール** | 2時間ごと + 毎日 21:30 UTC（6:30 JST、Slack 通知つき） |
| **手動実行** | `workflow_dispatch`（`send_slack` パラメータ入力可） |

#### ジョブ設定

| 項目 | 値 | 備考 |
|------|------|------|
| **timeout-minutes** | 180 | 23区全スクレイピング + enrichment パイプラインに十分な余裕 |
| **同時実行制御** | `cancel-in-progress: false` | 実行中のジョブが完了するまで新規実行はキュー待機 |

#### ジョブフロー

```
1. actions/checkout
2. actions/setup-python@v5 (Python 3.9)
3. pip install -r scraping-tool/requirements.txt
4. scripts/update_listings.sh --no-git
   ├── main.py（スクレイピング）
   ├── check_changes.py（差分チェック → 変更なしなら早期終了）
   ├── build_units_cache.py（総戸数・階数・権利形態・間取り図キャッシュ更新）
   ├── merge_detail_cache.py（詳細キャッシュマージ）
   ├── sumai_surfin_enricher.py（住まいサーフィン + ss_address 取得）
   ├── build_map_viewer.py（地図ビューア生成 + ジオコーディング）
   ├── embed_geocode.py（座標埋め込み）
   ├── geocode_cross_validator.py（座標相互検証 + 修正）
   ├── hazard_enricher.py（ハザード情報）
   ├── floor_plan_enricher.py（間取り図画像URL取得。HOME'S 無効化により現在自動スキップ）
   ├── upload_floor_plans.py（間取り図画像→Firebase Storageアップロード）
   ├── reinfolib_enricher.py（不動産情報ライブラリ相場）
   ├── estat_enricher.py（e-Stat 人口動態）
   ├── generate_report.py（レポート生成）
   ├── send_push.py（FCM プッシュ通知）
   └── upload_scraping_log.py（実行ログ → Firestore）
5. 変更あり + Slack 通知タイム → slack_notify.py（Slack 通知、1日1回 6:30 JST のみ）
6. 変更あり → git commit & push
```

### 8.2 不動産情報ライブラリ・人口動態キャッシュ更新ワークフロー

**ファイル**: `.github/workflows/update-reinfolib-cache.yml`

定期的に不動産情報ライブラリ API と e-Stat API からキャッシュデータを事前構築する。`update-listings.yml` のメインパイプラインではこのキャッシュを参照するのみで、API を直接叩かない。

| ステップ | 処理 |
|---------|------|
| 1 | `reinfolib_cache_builder.py` → `data/reinfolib_prices.json`, `data/reinfolib_trends.json` |
| 2 | `fetch_station_prices.py` → `data/station_price_history.json` |
| 3 | `reinfolib_land_price_builder.py` → `data/reinfolib_land_prices.json` |
| 4 | `estat_population_builder.py` → `data/estat_population.json` |
| 5 | `build_transaction_feed.py` → `results/transactions.json`（首都圏成約実績フィード） |

#### 必要なシークレット

| シークレット | 用途 |
|------------|------|
| `SUMAI_USER` | 住まいサーフィン ユーザー名 |
| `SUMAI_PASS` | 住まいサーフィン パスワード |
| `FIREBASE_SERVICE_ACCOUNT` | Firebase サービスアカウント JSON 文字列 |
| `SLACK_WEBHOOK_URL` | Slack Webhook URL |
| `REINFOLIB_API_KEY` | 不動産情報ライブラリ API キー（update-reinfolib-cache.yml で使用） |
| `ESTAT_API_KEY` | e-Stat アプリケーション ID（update-reinfolib-cache.yml で使用） |
| `GITHUB_TOKEN` | リポジトリ Read and Write 権限 |

### 8.3 iOS デプロイスクリプト

**ファイル**: `real-estate-ios/scripts/deploy.sh`

CLI からアーカイブ → App Store Connect アップロードまでを一括実行するスクリプト。App Store Connect API Key で認証。

#### コマンド

| コマンド | 動作 |
|---------|------|
| `./scripts/deploy.sh` | アーカイブ + アップロード（フル実行） |
| `./scripts/deploy.sh --archive` | アーカイブのみ |
| `./scripts/deploy.sh --upload` | 既存アーカイブのアップロードのみ |
| `./scripts/deploy.sh --setup` | API Key の初回セットアップ（対話式） |

#### 前提条件

| 項目 | 詳細 |
|------|------|
| **App Store Connect API Key** | `~/.config/real-estate-deploy/config` に Key ID・Issuer ID・キーパスを保存 |
| **Apple Distribution 証明書** | キーチェーンに配布用証明書が必要（Xcode → Settings → Accounts → Manage Certificates で作成） |
| **署名スタイル** | Automatic（`-allowProvisioningUpdates` で自動取得） |
| **チーム ID** | `YRP5KV2X62` |

---

## 9. 購入条件・フィルタロジック

### 9.1 スクレイピング検索条件（config.py）

| 条件 | 値 | 根拠 |
|------|-----|------|
| **エリア** | 東京23区 | — |
| **価格** | 7,500万〜1億円 | 住み替え前提の投資判断 |
| **面積** | 60㎡以上（上限なし） | 需要の厚いゾーン |
| **間取り** | 2LDK / 3LDK（プレフィックス "2", "3"） | 買い手母集団が厚い |
| **築年** | 実行年 − 20年以降 | 新耐震 + 築浅優先 |
| **駅徒歩** | 7分以内 | ドラフト条件の厳格化 |
| **総戸数** | 50戸以上 | 管理安定性・流動性 |
| **路線** | JR / 東京メトロ / 都営 / 主要私鉄 | 需要の厚い路線に限定 |
| **リクエスト間隔** | SUUMO: 2秒 | 負荷軽減 |
| **タイムアウト** | 60秒 / リトライ3回 | 安定性確保 |
| **HOME'S** | **無効**（コード残存、定期実行では未使用） | WAF によりCI/CDパイプラインがタイムアウトするため無効化 |

### 9.2 Firestore 経由の条件上書き

`scraping_config/default` に保存された条件は、`firestore_config_loader.py` が `FIREBASE_SERVICE_ACCOUNT` 環境変数の存在時に自動的に `config` モジュールをパッチする。iOS アプリの設定画面から条件を変更可能。

### 9.3 iOS アプリのフィルタロジック（共通化）

`ListingFilter.apply(to:)` が物件一覧（ListingListView）と地図（MapTabView）の両方でフィルタ条件を適用する共通メソッドとして使用される。

- **流れ**: View 側で前処理（お気に入りタブ・座標有無・掲載終了除外など）→ `filter.apply(to: baseList)` → View 側で後処理（検索テキスト・ソートなど）
- **ヘルパー**: `availableLayouts(from:)`, `availableWards(from:)`, `availableRouteStations(from:)` がフィルタシートの選択肢データ生成に使用される

### 9.4 購入判断フロー

```
1. 物件候補を20件拾う（駅徒歩/広さ/築年で一次フィルタ）
2. 管理計画認定の有無を必須で確認（対象外は候補から外す）
3. 管理書類で10件に絞る（長期修繕計画・積立・修繕履歴）
4. REINS 成約データで「売れる速度」「価格推移」を見て最終3件
5. 3件のみ内見（現地で売却時の説明コストになる瑕疵を潰す）
```

---

## 10. 非機能要件

### 10.1 パフォーマンス

| 処理 | 最適化手法 |
|------|-----------|
| **データ取得** | 中古/新築を `async let` で並列 HTTP リクエスト |
| **JSON デコード** | `Task.detached(priority: .userInitiated)` でバックグラウンド |
| **DB 同期** | `identityKey → Listing` の Dictionary で O(1) ルックアップ |
| **GeoJSON デコード** | バックグラウンドスレッド |
| **DateFormatter** | `static let` で使い回し |
| **二重更新防止** | `guard !isRefreshing` でガード |
| **ETag** | 304 Not Modified でダウンロードスキップ |
| **リスト行** | テキストと SF Symbol のみ（画像なし、軽量レンダリング） |

### 10.2 オフライン動作

| 画面 | オフライン時の挙動 |
|------|-------------------|
| **一覧（中古/新築）** | SwiftData キャッシュから表示。更新はエラー表示。 |
| **お気に入り** | ローカルから表示。Firestore 同期は次回オンライン時。 |
| **地図** | キャッシュ済みピン表示。未キャッシュのハザードタイルは非表示。 |
| **設定** | 全項目表示可能。フルリフレッシュはエラー。 |
| **詳細** | ローカルデータ表示。外部リンクはブラウザがオフラインエラー。 |
| **通勤時間** | MKDirections はオフライン不可。キャッシュ済み結果は表示。 |

### 10.3 アクセシビリティ

| 項目 | 対応 |
|------|------|
| **Dynamic Type** | 全画面でシステムフォントスタイル使用、ハードコードサイズなし |
| **VoiceOver** | 一覧行に `accessibilityLabel`（物件名・価格・面積・徒歩）を設定 |
| **色のコントラスト** | セマンティックカラー使用、ライト/ダークモードで自動調整 |
| **タップターゲット** | 最小 44pt |
| **操作ヒント** | `accessibilityHint`（「タップで詳細。ハートでいいね」） |

### 10.4 セキュリティ

| 項目 | 対応 |
|------|------|
| **認証** | Google サインイン + メールホワイトリスト |
| **Firestore** | 認証済みユーザーのみ読み書き |
| **Storage** | 認証済みユーザーのみ。内見写真: 10MB/画像のみ制限。間取り図: 読み取りのみ（Admin SDK が書き込み） |
| **Admin SDK** | サービスアカウントは Firestore ルールの制約を受けない |
| **環境変数** | シークレットは GitHub Actions Secrets で管理、`.env` は `.gitignore` |

---

## 11. 用語集

| 用語 | 定義 |
|------|------|
| **listing** | 物件1件のデータ |
| **identity_key** | 名前・間取り・面積・住所・築年・路線・徒歩で一意化するキー（価格を含まない） |
| **listing_key** | identity_key + 価格。重複除去に使用 |
| **annotation** | いいね・コメント・写真のユーザーデータ。Firebase Firestore で家族間共有 |
| **property_type** | `"chuko"`（中古）または `"shinchiku"`（新築） |
| **hazard overlay** | 国土地理院のハザードマップタイルを地図に重畳表示するレイヤー。液状化・揺れやすさは GSI タイル非公開のため治水地形分類図（`lcmfc2`）で代替 |
| **enricher** | スクレイピング後にデータを付加するスクリプト群（通勤・ハザード・住まいサーフィン） |
| **identity_key → docId** | SHA256(identity_key) の先頭16文字。Firestore のドキュメント ID |
| **ETag** | HTTP キャッシュ制御ヘッダー。304 Not Modified でダウンロードをスキップ |
| **Liquid Glass** | iOS 26 のデザインシステム。半透明のガラス質感 |
| **OOUI** | Object-Oriented User Interface。オブジェクト中心の UI 設計 |
| **HIG** | Human Interface Guidelines。Apple のデザインガイドライン |
| **沖式** | 住まいサーフィンの不動産評価指標。時価算出・儲かる確率等 |
| **REINS** | Real Estate Information Network System。不動産流通標準情報システム |
| **FCM** | Firebase Cloud Messaging。リモートプッシュ通知サービス |

---

## 付録 A: 環境変数一覧

| 変数名 | 用途 | 使用場所 |
|--------|------|----------|
| `SUMAI_USER` | 住まいサーフィン ユーザー名 | GitHub Actions, sumai_surfin_enricher.py |
| `SUMAI_PASS` | 住まいサーフィン パスワード | GitHub Actions, sumai_surfin_enricher.py |
| `FIREBASE_SERVICE_ACCOUNT` | Firebase サービスアカウント JSON | GitHub Actions, firestore_config_loader.py, upload_scraping_log.py, send_push.py |
| `FIREBASE_PROJECT_ID` | FCM フォールバック | send_push.py |
| `SLACK_WEBHOOK_URL` | Slack Webhook URL | GitHub Actions, slack_notify.py |
| `REINFOLIB_API_KEY` | 不動産情報ライブラリ API キー | update-reinfolib-cache.yml, reinfolib_cache_builder.py, fetch_station_prices.py, build_transaction_feed.py |
| `ESTAT_API_KEY` | e-Stat アプリケーション ID | update-reinfolib-cache.yml, estat_population_builder.py |

---

## 付録 B: ドキュメント相互参照

| ファイル | 内容 |
|---------|------|
| `docs/SPECIFICATION.md` | **本ファイル**（総合仕様書） |
| `docs/10year-index-mansion-conditions-draft.md` | 購入条件ドラフト |
| `docs/initial-consultation.md` | 初回相談メモ |
| `real-estate-ios/docs/REQUIREMENTS.md` | iOS アプリ要件定義 |
| `real-estate-ios/docs/DB-STRATEGY.md` | DB 設計方針 |
| `real-estate-ios/docs/DESIGN.md` | デザイン指針 |
| `real-estate-ios/docs/FIREBASE-SETUP.md` | Firebase セットアップ手順 |
| `real-estate-ios/docs/TODO.md` | 未確定事項・TODO |
| `scraping-tool/README.md` | スクレイピングツール詳細 |
| `scraping-tool/docs/GITHUB_SETUP.md` | GitHub Actions セットアップ |
| `scraping-tool/docs/SLACK_SETUP.md` | Slack 通知セットアップ |

---

## 付録 C: JSON データフォーマット

### C.1 中古マンション（latest.json）

```json
[
  {
    "source": "suumo",
    "url": "https://suumo.jp/...",
    "name": "○○マンション",
    "price_man": 8500,
    "address": "東京都○○区...",
    "station_line": "東京メトロ○○線 ○○駅",
    "walk_min": 5,
    "area_m2": 65.0,
    "layout": "3LDK",
    "built_year": 2010,
    "built_str": "2010年3月",
    "total_units": 120,
    "floor_position": 8,
    "floor_total": 15,
    "floor_structure": "RC",
    "ownership": "所有権",
    "list_ward_roman": "minato",
    "property_type": "chuko",
    "latitude": 35.6580,
    "longitude": 139.7513,
    "duplicate_count": 1,
    "ss_profit_pct": 85,
    "ss_oki_price_70m2": 9200,
    "ss_value_judgment": "割安",
    "ss_appreciation_rate": 12.5,
    "ss_radar_data": "{...}",
    "hazard_info": "{...}",
    "commute_info": "{...}",
    "floor_plan_images": ["https://firebasestorage.googleapis.com/v0/b/real-estate-app-5b869.firebasestorage.app/o/floor_plans%2Fabc123def456.jpg?alt=media&token=..."]
  }
]
```

### C.2 新築マンション（latest_shinchiku.json）

```json
[
  {
    "source": "suumo",
    "url": "https://suumo.jp/...",
    "name": "○○レジデンス",
    "price_man": 7800,
    "price_max_man": 9500,
    "address": "東京都○○区...",
    "station_line": "JR○○線 ○○駅",
    "walk_min": 3,
    "area_m2": 60.0,
    "area_max_m2": 75.0,
    "layout": "2LDK~3LDK",
    "delivery_date": "2027年9月上旬予定",
    "total_units": 200,
    "list_ward_roman": "shibuya",
    "property_type": "shinchiku",
    "latitude": 35.6600,
    "longitude": 139.7000
  }
]
```

### C.3 コメントデータ（commentsJSON）

```json
[
  {
    "id": "uuid-string",
    "text": "内見メモ：日当たり良好",
    "authorName": "Masaki",
    "authorId": "firebase-uid",
    "createdAt": "2025-01-15T10:30:00Z"
  }
]
```

### C.4 通勤時間データ（commuteInfoJSON）

```json
{
  "playground": {
    "minutes": 25,
    "summary": "東京メトロ半蔵門線→半蔵門駅 徒歩5分",
    "transfers": 1,
    "calculatedAt": "2025-01-15T10:00:00Z"
  },
  "m3career": {
    "minutes": 30,
    "summary": "東京メトロ日比谷線→虎ノ門ヒルズ駅 徒歩7分",
    "transfers": 0,
    "calculatedAt": "2025-01-15T10:00:00Z"
  }
}
```
